(function(){var m,n,h,l,k,d=function(b,a){return function(){return b.apply(a,arguments)}},p=[].indexOf||function(b){for(var a=0,g=this.length;a<g;a++)if(a in this&&this[a]===b)return a;return-1};h=function(){};k=function(){return function(b,a,g){g.prototype=b.prototype;g=new g;b=b.apply(g,a);return Object(b)===b?b:g}(choco.Timer,arguments,function(){})};this.CURRENT_TIME=Math.floor((new Date).getTime()/1E3);this.RECENT_TIME=this.CURRENT_TIME-2592E3;m=Haml('.game(data-id="#{g.itemId}" style="width:#{width}px")\n  .header\n    .label.label-info(data-text="#{g.title}" title="#{g.title} (#{g.romajiTitle})") = shorten(g.title)\n    :if g.series\n      .label.label-success(title="#{g.series}\u30b7\u30ea\u30fc\u30ba") = g.series\n    :if g.brand\n      :for it in g.brand.split(\',\')\n        .label.label-inverse(title="\u30d6\u30e9\u30f3\u30c9: #{it}") = it\n    :if g.visitCount\n      :if visitColor === \'\'\n        .badge(title="\u5b57\u5e55\u6570/\u5f3e\u5e55\u6570/\u518d\u751f\u6570") = g.countString\n      :if visitColor === \'o\'\n        .badge.badge-warning(title="\u5b57\u5e55\u6570/\u5f3e\u5e55\u6570/\u518d\u751f\u6570") = g.countString\n      :if visitColor === \'r\'\n        .badge.badge-important(title="\u5b57\u5e55\u6570/\u5f3e\u5e55\u6570/\u518d\u751f\u6570") = g.countString\n      :if visitColor === \'g\'\n        .badge.badge-success(title="\u5b57\u5e55\u6570/\u5f3e\u5e55\u6570/\u518d\u751f\u6570") = g.countString\n      :if visitColor === \'b\'\n        .badge.badge-inverse(title="\u5b57\u5e55\u6570/\u5f3e\u5e55\u6570/\u518d\u751f\u6570") = g.countString\n    :if scoreColor\n      :if scoreColor === \'o\'\n        .badge.badge-warning(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'r\'\n        .badge.badge-important(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'g\'\n        .badge.badge-success(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'b\'\n        .badge.badge-inverse(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n    :if g.tags\n      :for it in g.tags.split(\',\')\n        .label(title="#{it}") = it\n    :if g.date\n      .label(data-text="#{g.moment.format(\'YYYYMM\')}" title="\u767a\u58f2\u65e5") = g.moment.format(\'M/D/YYYY\')\n    :if g.date > CURRENT_TIME\n      .label.label-important(title="\u672a\u767a\u58f2") \u672a\u767a\u58f2\n    :if sizeColor\n      :if sizeColor === \'o\'\n        .label.label-warning(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'r\'\n        .label.label-important(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'g\'\n        .label.label-success(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'b\'\n        .label.label-inverse(title="\u5bb9\u91cfMB" data-text="MB") #{sizeTag}\n  %img(src="#{g.imageUrl}" title="#{tip}")\n  .footer\n    :if g.artists\n      :for it in g.artists.split(\',\')\n        .label(data-text="#{it}" title="\u539f\u753b: #{it}") = \'*\' + it\n    :if g.sdartists\n      :for it in g.sdartists.split(\',\')\n        .label(data-text="#{it}" title="SD\u539f\u753b: #{it}") = \'.\' + it\n    :if g.writers\n      :for it in g.writers.split(\',\')\n        .label(data-text="#{it}" title="\u811a\u672c: #{it}") = \'+\' + it\n    :if g.musicians\n      :for it in g.musicians.split(\',\')\n        .label(data-text="#{it}" title="\u97f3\u697d: #{it}") = \'\u266a\' + it');
this.shorten=function(b,a){null==a&&(a=11);return b.length<=a?b:b.slice(0,+(a-1)+1||9E9)+".."};n=function(){function b(a){this.bean=a;this._renderGame=d(this._renderGame,this);this.render=d(this.render,this);this.triggerSearch=d(this.triggerSearch,this);this.search=d(this.search,this);this.rebind=d(this.rebind,this);this.more=d(this.more,this);this.repaint=d(this.repaint,this);this.refresh=d(this.refresh,this);this.bind=d(this.bind,this);this.toggleKeyword=d(this.toggleKeyword,this);this.queryGames=
d(this.queryGames,this);this.zoom=d(this.zoom,this);this.setItemWidth=d(this.setItemWidth,this);this.masonryStopAni=d(this.masonryStopAni,this);this.masonryStartAni=d(this.masonryStartAni,this);this.masonryStartAniLater=d(this.masonryStartAniLater,this);this.masonryLayoutLater=d(this.masonryLayoutLater,this);this.filters={tags:[]};this.options={sort:"date",reverse:!0};this.$search=$("input#search");this.searchText="";this.searchTimer=k(400,this.triggerSearch);this.$container=$("#"+this.id);this.$container.masonry({itemSelector:this.itemSelector});
this.masonryLayoutTimer=k(200,function(a){return function(){return a.$container.masonry()}}(this));this.masonryAnimateTimer=k(600,this.masonryStartAni);this.scrollTimer=k(2E3);this.bind();this.refresh()}b.prototype.id="games";b.prototype.itemSelector=".game";b.prototype.itemWidth=160;b.prototype.masonryLayoutLater=function(){return this.masonryLayoutTimer.start()};b.prototype.masonryStartAniLater=function(){return this.masonryAnimateTimer.start()};b.prototype.masonryStartAni=function(){return this.$container.masonry({isAnimated:!0,
transitionDuration:400})};b.prototype.masonryStopAni=function(){this.masonryAnimateTimer.stop();return this.$container.masonry({isAnimated:!1,transitionDuration:0})};b.prototype.setItemWidth=function(a){a=Math.floor(a);if(this.itemWidth!==a)return this.itemWidth=a,$(this.itemSelector).width(a),this.masonryLayoutLater()};b.prototype.zoom=function(a){return this.setItemWidth(160*a)};b.prototype.queryPageSize=function(){var a;a=$(document).width();return Math.max(50,a/20)};b.prototype.queryMorePageSize=
function(){var a;a=$(document).width();return Math.max(25,a/30)};b.prototype.queryGames=function(a){var g,b,f,c;g=JSON.parse(this.bean.games.apply(this.bean,[(null!=a?a.start:void 0)||0,(null!=a?a.count:void 0)||50,this.options.sort,this.options.reverse,this.filters?JSON.stringify(this.filters):""]));if(g.length)for(f=0,c=g.length;f<c;f++)a=g[f],a.moment=moment(1E3*a.date),0<a.fileSize&&(a.fileSize=Math.floor(a.fileSize/1048576)),b=a.visitCount||1,a.commentCount&&(b=a.commentCount+"/"+b),a.subtitleCount&&
(b=a.subtitleCount+"/"+b),a.countString=b;return g};b.prototype.toggleKeyword=function(a){return 0<=p.call(this.filters.tags,a)?this.filters.tags=this.filters.tags.filter(function(g){return g!==a}):this.filters.tags.push(a)};b.prototype.bind=function(){var a;h("bind: enter");this.$search.keyup(function(a){return function(){return a.searchTimer.start()}}(this));$(".search .close").click(function(a){return function(){a.search("");return!1}}(this));$(window).on("scroll resize",function(a){return function(){var b;
b=a.bean.height();if($(window).scrollTop()+b>$(document).height()-Math.max(200,b/2)&&a.bean.currentCount()<a.bean.totalCount()&&!a.scrollTimer.active)return a.scrollTimer.start(),a.more()}}(this)).keydown(function(a){return function(b){if(b.ctrlKey||b.metaKey)switch(String.fromCharCode(b.which).toLowerCase()){case "f":return b.preventDefault(),a.$search.focus()}}}(this));a=this;$("#keyword .close").click(function(){a.filters.tags.length&&($("#keyword .label").removeClass("label-info"),a.filters.tags.length=
0,a.refresh());return!1});$("#keyword .label").click(function(){a.toggleKeyword($.trim(this.innerHTML));this.classList.toggle("label-info");a.refresh();return!1});$(".options .option-set a").click(function(){var b,e,f;e=$(this);if(e.hasClass("selected"))return!1;b=e.closest(".option-set");b.find(".selected").removeClass("selected");e.addClass("selected");f=b.data("option-key");e=e.data("option-value");"filter"===f?(b=b.data("option-group"),""===e?delete a.filters[b]:a.filters[b]=e):a.options[f]=e;
a.refresh();return!1});return h("bind: leave")};b.prototype.refresh=function(){var a;h("refresh: enter");this.masonryLayoutTimer.stop();this.masonryStopAni();a=$(this.itemSelector);a.length&&this.$container.masonry("remove",a);this.repaint();return this.masonryStartAniLater()};b.prototype.showBlocker=function(){return $(".blocker:hidden").fadeIn()};b.prototype.hideBlocker=function(){return $(".blocker:visible").fadeOut()};b.prototype.repaint=function(){var a,b;h("repaint: enter");b=this.queryGames({count:this.queryPageSize()});
b.length?(this.hideBlocker(),this.games=new function(){var a,f,c;f=0;for(c=b.length;f<c;f++)a=b[f],this[a.itemId]=a;return this},a=$(this.render(b)),this.$container.append(a).masonry("appended",a),this.rebind(),this.masonryLayoutLater(),a.find("img").load(this.masonryLayoutLater)):(this.games={},this.showBlocker());return h("repaint: leave")};b.prototype.more=function(){var a,b,e,f;h("more: enter");a=this.queryGames({count:this.queryMorePageSize(),start:this.bean.currentCount()});if(a.length){e=0;
for(f=a.length;e<f;e++)b=a[e],this.games[b.itemId]=b;a=$(this.render(a));this.$container.append(a).masonry("appended",a);this.rebind();this.masonryLayoutLater();a.find("img").load(this.masonryLayoutLater)}return h("more: leave")};b.prototype.rebind=function(){var a;h("rebind: enter");a=this;$(this.itemSelector+".new").each(function(){var b;b=$(this).removeClass("new");b.find("img").click(function(){bean.showItem(this.parentNode.dataset.id);return!1});return b.find(".label").click(function(){a.search(this.dataset.text||
this.innerHTML);return!1})});return h("rebind: leave")};b.prototype.search=function(a){return this.$search.val(a).trigger("keyup")};b.prototype.triggerSearch=function(){var a;a=$.trim(this.$search.val());if(a!==this.searchText)return this.searchText=a,""===a?delete this.filters.search:this.filters.search=a,this.refresh()};b.prototype.render=function(a){return a.map(this._renderGame).join("")};b.prototype._renderGame=function(a){var b,e,f,c,d;c=a.title;a.romajiTitle&&(c+=" ("+a.romajiTitle+")");c=
c.replace(/"/g,"'");a.date>CURRENT_TIME?c+=" \u672a\u767a\u58f2":a.date>RECENT_TIME&&(c+=" \u65b0\u4f5c");a.local&&(c+=" \u6240\u6301\u3061");a.otome&&(c+=" \u5973\u6027\u5411\u3051");c+=a.okazu?" \u629c\u304d\u30b2\u30fc":" \u7d14\u611b\u7cfb";b=a.scapeMedian?5>a.scapeCount?"b":90<=a.scapeMedian||500<a.scapeCount?"o":80<=a.scapeMedian||300<a.scapeCount?"r":70<=a.scapeMedian||100<a.scapeCount?"g":"b":"";d=5E3<a.subtitleCount?"o":6E3>a.visitCount&&5E3<a.commentCount?"o":3E3>a.visitCount&&500<a.commentCount?
"r":300>a.visitCount?"":1E3>a.visitCount?"b":3E3>a.visitCount?"g":6E3>a.visitCount?"r":"o";e=a.fileSize?1024>a.fileSize?"b":2048>a.fileSize?"g":4048>a.fileSize?"r":"o":"";f=a.fileSize?1024>a.fileSize?a.fileSize+"M":Math.round(a.fileSize/1024*100)/100+"G":"";e=m({g:a,tip:c,width:this.itemWidth,scoreColor:b,visitColor:d,sizeColor:e,sizeTag:f});b=["game","new"];b.push(a.otome?"otome":a.okazu?"okazu":"junai");return e.replace("game",b.join(" "))};return b}();l=function(){var b,a;if(null==this.bean)return h("init: wait"),
setTimeout(l,100);h("init: enter");moment.locale("ja");b=new n(this.bean);a=new ZoomSlider(function(a){return b.zoom(1+1.1*a)});new Toolbar(this.bean,{width:60,height:229,move:a.reloadOffset});this.gameManager=b;return h("init: leave")};$(function(){return l()});this.search=function(b){if(window.gameManager)return gameManager.search(b)}}).call(this);
