(function(){var k,l,f,g,h,c=function(b,a){return function(){return b.apply(a,arguments)}},m=[].indexOf||function(b){for(var a=0,d=this.length;a<d;a++)if(a in this&&this[a]===b)return a;return-1};f=function(){};h=function(){return function(b,a,d){d.prototype=b.prototype;d=new d;b=b.apply(d,a);return Object(b)===b?b:d}(choco.Timer,arguments,function(){})};this.CURRENT_TIME=Math.floor((new Date).getTime()/1E3);this.RECENT_TIME=this.CURRENT_TIME-2592E3;k=Haml('.game(data-id="#{g.itemId}" style="width:#{width}px")\n  .header\n    .label.label-info(data-text="#{g.title}" title="#{g.title} (#{g.romajiTitle})") = shorten(g.title)\n    :if g.series\n      .label.label-success(title="#{g.series}\u30b7\u30ea\u30fc\u30ba") = g.series\n    :if g.brand\n      :for it in g.brand.split(\',\')\n        .label.label-inverse(title="\u30d6\u30e9\u30f3\u30c9: #{it}") = it\n    :if g.visitCount\n      :if visitColor === \'\'\n        .badge(title="\u8a2a\u554f\u6570") #{g.visitCount}\n      :if visitColor === \'o\'\n        .badge.badge-warning(title="\u8a2a\u554f\u6570") = g.visitCount\n      :if visitColor === \'r\'\n        .badge.badge-important(title="\u8a2a\u554f\u6570") = g.visitCount\n      :if visitColor === \'g\'\n        .badge.badge-success(title="\u8a2a\u554f\u6570") = g.visitCount\n      :if visitColor === \'b\'\n        .badge.badge-inverse(title="\u8a2a\u554f\u6570") = g.visitCount\n    :if scoreColor\n      :if scoreColor === \'o\'\n        .badge.badge-warning(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'r\'\n        .badge.badge-important(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'g\'\n        .badge.badge-success(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'b\'\n        .badge.badge-inverse(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n    :if g.tags\n      :for it in g.tags.split(\',\')\n        .label(title="#{it}") = it\n    :if g.date\n      .label(data-text="#{g.moment.format(\'YYYYMM\')}" title="\u767a\u58f2\u65e5") = g.moment.format(\'M/D/YYYY\')\n    :if g.date > CURRENT_TIME\n      .label.label-important(title="\u672a\u767a\u58f2") \u672a\u767a\u58f2\n  %img.img-rounded(src="#{g.imageUrl}" title="#{tip}")\n  .footer\n    :if g.artists\n      :for it in g.artists.split(\',\')\n        .label(data-text="#{it}" title="\u539f\u753b: #{it}") = \'*\' + it\n    :if g.sdartists\n      :for it in g.sdartists.split(\',\')\n        .label(data-text="#{it}" title="SD\u539f\u753b: #{it}") = \'.\' + it\n    :if g.writers\n      :for it in g.writers.split(\',\')\n        .label(data-text="#{it}" title="\u811a\u672c: #{it}") = \'+\' + it\n    :if g.musicians\n      :for it in g.musicians.split(\',\')\n        .label(data-text="#{it}" title="\u97f3\u697d: #{it}") = \'\u266a\' + it');
this.shorten=function(b,a){null==a&&(a=11);return b.length<=a?b:b.slice(0,+(a-1)+1||9E9)+".."};l=function(){function b(a){this.bean=a;this._renderGame=c(this._renderGame,this);this.render=c(this.render,this);this.triggerSearch=c(this.triggerSearch,this);this.search=c(this.search,this);this.rebind=c(this.rebind,this);this.more=c(this.more,this);this.repaint=c(this.repaint,this);this.hideSpinner=c(this.hideSpinner,this);this.showSpinner=c(this.showSpinner,this);this.refresh=c(this.refresh,this);this.bind=
c(this.bind,this);this.toggleKeyword=c(this.toggleKeyword,this);this.queryGames=c(this.queryGames,this);this.zoom=c(this.zoom,this);this.setItemWidth=c(this.setItemWidth,this);this.filters={tags:[]};this.options={sort:"date",reverse:!0};this.spinner=new Spinner;this.$search=$("input#search");this.searchText="";this.searchTimer=h(400,this.triggerSearch);this.$container=$("#"+this.id);this.$container.masonry({itemSelector:this.itemSelector,isAnimated:!1,transitionDuration:0});this.scrollTimer=h(2E3);
this.bind();this.refresh()}b.prototype.id="games";b.prototype.itemSelector=".game";b.prototype.itemWidth=160;b.prototype.setItemWidth=function(a){a=Math.floor(a);if(this.itemWidth!==a)return this.itemWidth=a,$(this.itemSelector).width(a),this.$container.masonry()};b.prototype.zoom=function(a){return this.setItemWidth(160*a)};b.prototype.queryPageSize=function(){var a;a=$(document).width();return Math.max(50,a/20)};b.prototype.queryMorePageSize=function(){var a;a=$(document).width();return Math.max(25,
a/30)};b.prototype.queryGames=function(a){var d,b,e;d=JSON.parse(this.bean.games.apply(this.bean,[(null!=a?a.start:void 0)||0,(null!=a?a.count:void 0)||50,this.options.sort,this.options.reverse,this.filters?JSON.stringify(this.filters):""]));if(d.length)for(b=0,e=d.length;b<e;b++)a=d[b],a.moment=moment(1E3*a.date);return d};b.prototype.toggleKeyword=function(a){return 0<=m.call(this.filters.tags,a)?this.filters.tags=this.filters.tags.filter(function(d){return d!==a}):this.filters.tags.push(a)};b.prototype.bind=
function(){var a;f("bind: enter");this.$search.keyup(function(a){return function(){return a.searchTimer.start()}}(this));$(".search .close").click(function(a){return function(){a.search("");return!1}}(this));$(window).on("scroll resize",function(a){return function(){var b;b=a.bean.height();if($(window).scrollTop()+b>$(document).height()-Math.max(200,b/2)&&a.bean.currentCount()<a.bean.totalCount()&&!a.scrollTimer.active)return a.scrollTimer.start(),a.more()}}(this)).keydown(function(a){return function(b){if(b.ctrlKey||
b.metaKey)switch(String.fromCharCode(b.which).toLowerCase()){case "f":return b.preventDefault(),a.$search.focus()}}}(this));a=this;$("#keyword .close").click(function(){a.filters.tags.length&&($("#keyword .label").removeClass("label-info"),a.filters.tags.length=0,a.refresh());return!1});$("#keyword .label").click(function(){a.toggleKeyword($.trim(this.innerHTML));this.classList.toggle("label-info");a.refresh();return!1});$(".options .option-set a").click(function(){var d,b,e;b=$(this);if(b.hasClass("selected"))return!1;
d=b.closest(".option-set");d.find(".selected").removeClass("selected");b.addClass("selected");e=d.data("option-key");b=b.data("option-value");"filter"===e?(d=d.data("option-group"),""===b?delete a.filters[d]:a.filters[d]=b):a.options[e]=b;a.refresh();return!1});return f("bind: leave")};b.prototype.refresh=function(){var a;f("refresh: enter");a=$(this.itemSelector);a.length&&this.$container.masonry("remove",a);return this.repaint()};b.prototype.showBlocker=function(){return $(".blocker:hidden").fadeIn()};
b.prototype.hideBlocker=function(){return $(".blocker:visible").fadeOut()};b.prototype.showSpinner=function(){var a,b;a=$(window);b=document.getElementById("spinner");b.style.left=""+(a.scrollLeft()+this.bean.width()/2)+"px";b.style.top=""+(a.scrollTop()+this.bean.height()/2)+"px";$("#spinner").fadeIn();return this.spinner.spin(b)};b.prototype.hideSpinner=function(){$("#spinner").hide();return this.spinner.stop()};b.prototype.repaint=function(){var a,b;f("repaint: enter");b=this.queryGames({count:this.queryPageSize()});
b.length?(this.hideBlocker(),this.games=new function(){var a,e,c;e=0;for(c=b.length;e<c;e++)a=b[e],this[a.itemId]=a;return this},this.showSpinner(),a=$(this.render(b)).imagesLoaded(function(b){return function(){b.hideSpinner();b.$container.append(a).masonry("appended",a).masonry();return b.rebind()}}(this))):(this.games={},this.showBlocker());return f("repaint: leave")};b.prototype.more=function(){var a,b,c,e,g;f("more: enter");b=this.queryGames({count:this.queryMorePageSize(),start:this.bean.currentCount()});
if(b.length){e=0;for(g=b.length;e<g;e++)c=b[e],this.games[c.itemId]=c;a=$(this.render(b)).imagesLoaded(function(b){return function(){b.$container.append(a).masonry("appended",a).masonry();return b.rebind()}}(this))}return f("more: leave")};b.prototype.rebind=function(){var a;f("rebind: enter");a=this;$(""+this.itemSelector+".new").each(function(){var b;b=$(this).removeClass("new");b.find("img").click(function(){bean.showItem(this.parentNode.dataset.id);return!1});return b.find(".label").click(function(){a.search(this.dataset.text||
this.innerHTML);return!1})});return f("rebind: leave")};b.prototype.search=function(a){return this.$search.val(a).trigger("keyup")};b.prototype.triggerSearch=function(){var a;a=$.trim(this.$search.val());if(a!==this.searchText)return this.searchText=a,""===a?delete this.filters.search:this.filters.search=a,this.refresh()};b.prototype.render=function(a){return a.map(this._renderGame).join("")};b.prototype._renderGame=function(a){var b,c;b=a.title;a.romajiTitle&&(b+=" ("+a.romajiTitle+")");b=b.replace(/"/g,
"'");a.date>CURRENT_TIME?b+=" \u672a\u767a\u58f2":a.date>RECENT_TIME&&(b+=" \u65b0\u4f5c");a.local&&(b+=" \u6240\u6301\u3061");a.otome&&(b+=" \u5973\u6027\u5411\u3051");b+=a.okazu?" \u629c\u304d\u30b2\u30fc":" \u7d14\u611b\u7cfb";c=k({g:a,tip:b,width:this.itemWidth,scoreColor:a.scapeMedian?10>a.scapeCount?"b":90<=a.scapeMedian||500<a.scapeCount?"o":80<=a.scapeMedian||300<a.scapeCount?"r":70<=a.scapeMedian||100<a.scapeCount?"g":"b":"",visitColor:300>a.visitCount?"":1E3>a.visitCount?"b":3E3>a.visitCount?
"g":6E3>a.visitCount?"r":"o"});b=["game","new"];b.push(a.otome?"otome":a.okazu?"okazu":"junai");return c.replace("game",b.join(" "))};return b}();g=function(){var b,a;if(null==this.bean)return f("init: wait"),setTimeout(g,100);f("init: enter");b=new l(this.bean);a=new ZoomSlider(function(a){return b.zoom(1+a)});new Toolbar(this.bean,{width:60,height:229,move:a.reloadOffset});this.gameManager=b;return f("init: leave")};$(function(){return g()});this.search=function(b){if(window.gameManager)return gameManager.search(b)}}).call(this);
