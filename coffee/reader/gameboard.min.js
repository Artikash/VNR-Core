(function(){var l,m,c,k,g,d=function(b,a){return function(){return b.apply(a,arguments)}},n=[].indexOf||function(b){for(var a=0,f=this.length;a<f;a++)if(a in this&&this[a]===b)return a;return-1};c=function(){};g=function(){return function(b,a,f){f.prototype=b.prototype;f=new f;b=b.apply(f,a);return Object(b)===b?b:f}(choco.Timer,arguments,function(){})};this.CURRENT_TIME=Math.floor((new Date).getTime()/1E3);this.RECENT_TIME=this.CURRENT_TIME-2592E3;l=Haml('.game(data-id="#{g.itemId}" style="width:#{width}px")\n  .header\n    .label.label-info(data-text="#{g.title}" title="#{g.title} (#{g.romajiTitle})") = shorten(g.title)\n    :if g.series\n      .label.label-success(title="#{g.series}\u30b7\u30ea\u30fc\u30ba") = g.series\n    :if g.brand\n      :for it in g.brand.split(\',\')\n        .label.label-inverse(title="\u30d6\u30e9\u30f3\u30c9: #{it}") = it\n    :if g.visitCount\n      :if visitColor === \'\'\n        .badge(title="\u5f3e\u5e55\u6570(\u5b57\u5e55\u6570)/\u518d\u751f\u6570(\u4f7f\u7528\u8005)") = g.countString\n      :if visitColor === \'o\'\n        .badge.badge-warning(title="\u5f3e\u5e55\u6570(\u5b57\u5e55\u6570)/\u518d\u751f\u6570(\u4f7f\u7528\u8005)") = g.countString\n      :if visitColor === \'r\'\n        .badge.badge-important(title="\u5f3e\u5e55\u6570(\u5b57\u5e55\u6570)/\u518d\u751f\u6570(\u4f7f\u7528\u8005)") = g.countString\n      :if visitColor === \'g\'\n        .badge.badge-success(title="\u5f3e\u5e55\u6570(\u5b57\u5e55\u6570)/\u518d\u751f\u6570(\u4f7f\u7528\u8005)") = g.countString\n      :if visitColor === \'b\'\n        .badge.badge-inverse(title="\u5f3e\u5e55\u6570(\u5b57\u5e55\u6570)/\u518d\u751f\u6570(\u4f7f\u7528\u8005)") = g.countString\n    :if g.overallScoreCount\n      .badge.badge-important(title="\u7dcf\u5408\u5f97\u70b9\u00d7\u70b9\u6570")\n        &#9734;#{sprintf(\'%.1f\', g.overallScore)}\n        :if g.overallScoreCount > 1\n          x#{g.overallScoreCount}\n    :if g.ecchiScoreCount\n      .badge.badge-warning(title="\u3048\u3063\u3061\u5f97\u70b9\u00d7\u70b9\u6570")\n        H  #{sprintf(\'%.1f\', g.ecchiScore)}\n        :if g.ecchiScoreCount > 1\n          x#{g.ecchiScoreCount}\n    :if scoreColor\n      :if scoreColor === \'o\'\n        .badge.badge-warning(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'r\'\n        .badge.badge-important(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'g\'\n        .badge.badge-success(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n      :if scoreColor === \'b\'\n        .badge.badge-inverse(title="\u5f97\u70b9\u00d7\u70b9\u6570") #{g.scapeMedian}x#{g.scapeCount}\n    :if g.tags\n      :for it in g.tags.split(\',\')\n        .label(title="#{it}") = it\n    :if g.date\n      .label(data-text="#{g.moment.format(\'YYYYMM\')}" title="\u767a\u58f2\u65e5") = g.moment.format(\'M/D/YYYY\')\n    :if g.date > CURRENT_TIME\n      .label.label-important(title="\u672a\u767a\u58f2") \u672a\u767a\u58f2\n    :if sizeColor\n      :if sizeColor === \'o\'\n        .label.label-warning(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'r\'\n        .label.label-important(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'g\'\n        .label.label-success(title="\u5bb9\u91cfGB" data-text="GB") #{sizeTag}\n      :if sizeColor === \'b\'\n        .label.label-inverse(title="\u5bb9\u91cfMB" data-text="MB") #{sizeTag}\n  %img(src="#{g.imageUrl}" title="#{tip}")\n  .footer\n    :if g.artists\n      :for it in g.artists.split(\',\')\n        .label(data-text="#{it}" title="\u539f\u753b: #{it}") = \'*\' + it\n    :if g.sdartists\n      :for it in g.sdartists.split(\',\')\n        .label(data-text="#{it}" title="SD\u539f\u753b: #{it}") = \'.\' + it\n    :if g.writers\n      :for it in g.writers.split(\',\')\n        .label(data-text="#{it}" title="\u811a\u672c: #{it}") = \'+\' + it\n    :if g.musicians\n      :for it in g.musicians.split(\',\')\n        .label(data-text="#{it}" title="\u97f3\u697d: #{it}") = \'\u266a\' + it');
this.shorten=function(b,a){null==a&&(a=11);return b.length<=a?b:b.slice(0,+(a-1)+1||9E9)+".."};m=function(){function b(a){this.bean=a;this._renderGame=d(this._renderGame,this);this.render=d(this.render,this);this.triggerSearch=d(this.triggerSearch,this);this.search=d(this.search,this);this.rebind=d(this.rebind,this);this.more=d(this.more,this);this.repaint=d(this.repaint,this);this.refresh=d(this.refresh,this);this.bind=d(this.bind,this);this.toggleKeyword=d(this.toggleKeyword,this);this.queryGames=
d(this.queryGames,this);this.zoom=d(this.zoom,this);this.setItemWidth=d(this.setItemWidth,this);this.masonryStopAni=d(this.masonryStopAni,this);this.masonryStartAni=d(this.masonryStartAni,this);this.masonryStartAniLater=d(this.masonryStartAniLater,this);this.masonryLayoutLater=d(this.masonryLayoutLater,this);this.filters={tags:[]};this.options={sort:"date",reverse:!0};this.$search=$("input#search");this.searchText="";this.searchTimer=g(400,this.triggerSearch);this.$container=$("#"+this.id);this.$container.masonry({itemSelector:this.itemSelector});
this.masonryLayoutTimer=g(200,function(a){return function(){return a.$container.masonry()}}(this));this.masonryAnimateTimer=g(600,this.masonryStartAni);this.scrollTimer=g(2E3);this.bind();this.refresh()}b.prototype.id="games";b.prototype.itemSelector=".game";b.prototype.itemWidth=160;b.prototype.masonryLayoutLater=function(){return this.masonryLayoutTimer.start()};b.prototype.masonryStartAniLater=function(){return this.masonryAnimateTimer.start()};b.prototype.masonryStartAni=function(){return this.$container.masonry({isAnimated:!0,
transitionDuration:400})};b.prototype.masonryStopAni=function(){this.masonryAnimateTimer.stop();return this.$container.masonry({isAnimated:!1,transitionDuration:0})};b.prototype.setItemWidth=function(a){a=Math.floor(a);if(this.itemWidth!==a)return this.itemWidth=a,$(this.itemSelector).width(a),this.masonryLayoutLater()};b.prototype.zoom=function(a){return this.setItemWidth(160*a)};b.prototype.queryPageSize=function(){var a;a=$(document).width();return Math.max(50,a/20)};b.prototype.queryMorePageSize=
function(){var a;a=$(document).width();return Math.max(25,a/30)};b.prototype.queryGames=function(a){var f,b,d,e,c;b=JSON.parse(this.bean.games.apply(this.bean,[(null!=a?a.start:void 0)||0,(null!=a?a.count:void 0)||50,this.options.sort,this.options.reverse,this.filters?JSON.stringify(this.filters):""]));if(b.length)for(f=0,d=b.length;f<d;f++)a=b[f],a.moment=moment(1E3*a.date),0<a.fileSize&&(a.fileSize=Math.floor(a.fileSize/1048576)),e=a.visitCount||1,1<a.playUserCount&&(e+="("+a.playUserCount+")"),
c="",a.commentCount&&(c=a.commentCount),a.subtitleCount&&(c+="("+a.subtitleCount+")"),c&&(e=c+"/"+e),a.countString=e;return b};b.prototype.toggleKeyword=function(a){return 0<=n.call(this.filters.tags,a)?this.filters.tags=this.filters.tags.filter(function(f){return f!==a}):this.filters.tags.push(a)};b.prototype.bind=function(){var a;c("bind: enter");this.$search.keyup(function(a){return function(){return a.searchTimer.start()}}(this));$(".search .close").click(function(a){return function(){a.search("");
return!1}}(this));$(window).on("scroll resize",function(a){return function(){var b;b=a.bean.height();if($(window).scrollTop()+b>$(document).height()-Math.max(200,b/2)&&a.bean.currentCount()<a.bean.totalCount()&&!a.scrollTimer.active)return a.scrollTimer.start(),a.more()}}(this)).keydown(function(a){return function(b){if(b.ctrlKey||b.metaKey)switch(String.fromCharCode(b.which).toLowerCase()){case "f":return b.preventDefault(),a.$search.focus()}}}(this));a=this;$("#keyword .close").click(function(){a.filters.tags.length&&
($("#keyword .label").removeClass("label-info"),a.filters.tags.length=0,a.refresh());return!1});$("#keyword .label").click(function(){a.toggleKeyword($.trim(this.innerHTML));this.classList.toggle("label-info");a.refresh();return!1});$(".options .option-set a").click(function(){var b,h,c;h=$(this);if(h.hasClass("selected"))return!1;b=h.closest(".option-set");b.find(".selected").removeClass("selected");h.addClass("selected");c=b.data("option-key");h=h.data("option-value");"filter"===c?(b=b.data("option-group"),
""===h?delete a.filters[b]:a.filters[b]=h):a.options[c]=h;a.refresh();return!1});return c("bind: leave")};b.prototype.refresh=function(){var a;c("refresh: enter");this.masonryLayoutTimer.stop();this.masonryStopAni();a=$(this.itemSelector);a.length&&this.$container.masonry("remove",a);this.repaint();return this.masonryStartAniLater()};b.prototype.showBlocker=function(){return $(".blocker:hidden").fadeIn()};b.prototype.hideBlocker=function(){return $(".blocker:visible").fadeOut()};b.prototype.repaint=
function(){var a,b;c("repaint: enter");b=this.queryGames({count:this.queryPageSize()});b.length?(this.hideBlocker(),this.games=new function(){var a,c,e;a=0;for(e=b.length;a<e;a++)c=b[a],this[c.itemId]=c;return this},a=$(this.render(b)),this.$container.append(a).masonry("appended",a),this.rebind(),this.masonryLayoutLater(),a.find("img").load(this.masonryLayoutLater)):(this.games={},this.showBlocker());return c("repaint: leave")};b.prototype.more=function(){var a,b,d,g;c("more: enter");a=this.queryGames({count:this.queryMorePageSize(),
start:this.bean.currentCount()});if(a.length){b=0;for(g=a.length;b<g;b++)d=a[b],this.games[d.itemId]=d;a=$(this.render(a));this.$container.append(a).masonry("appended",a);this.rebind();this.masonryLayoutLater();a.find("img").load(this.masonryLayoutLater)}return c("more: leave")};b.prototype.rebind=function(){var a;c("rebind: enter");a=this;$(this.itemSelector+".new").each(function(){var b;b=$(this).removeClass("new");b.find("img").click(function(){bean.showItem(this.parentNode.dataset.id);return!1});
return b.find(".label").click(function(){a.search(this.dataset.text||this.innerHTML);return!1})});return c("rebind: leave")};b.prototype.search=function(a){return this.$search.val(a).trigger("keyup")};b.prototype.triggerSearch=function(){var a;a=$.trim(this.$search.val());if(a!==this.searchText)return this.searchText=a,""===a?delete this.filters.search:this.filters.search=a,this.refresh()};b.prototype.render=function(a){return a.map(this._renderGame).join("")};b.prototype._renderGame=function(a){var b,
c,d,e,g;e=a.title;a.romajiTitle&&(e+=" ("+a.romajiTitle+")");e=e.replace(/"/g,"'");a.date>CURRENT_TIME?e+=" \u672a\u767a\u58f2":a.date>RECENT_TIME&&(e+=" \u65b0\u4f5c");a.local&&(e+=" \u6240\u6301\u3061");a.otome&&(e+=" \u5973\u6027\u5411\u3051");e+=a.okazu?" \u629c\u304d\u30b2\u30fc":" \u7d14\u611b\u7cfb";b=a.scapeMedian?5>a.scapeCount?"b":90<=a.scapeMedian||500<a.scapeCount?"o":80<=a.scapeMedian||300<a.scapeCount?"r":70<=a.scapeMedian||100<a.scapeCount?"g":"b":"";g=5E3<a.subtitleCount?"o":6E3>a.visitCount&&
5E3<a.commentCount?"o":3E3>a.visitCount&&500<a.commentCount?"r":300>a.visitCount?"":1E3>a.visitCount?"b":3E3>a.visitCount?"g":6E3>a.visitCount?"r":"o";c=a.fileSize?1024>a.fileSize?"b":2048>a.fileSize?"g":4048>a.fileSize?"r":"o":"";d=a.fileSize?1024>a.fileSize?a.fileSize+"M":Math.round(a.fileSize/1024*100)/100+"G":"";c=l({g:a,tip:e,width:this.itemWidth,scoreColor:b,visitColor:g,sizeColor:c,sizeTag:d});b=["game","new"];b.push(a.otome?"otome":a.okazu?"okazu":"junai");return c.replace("game",b.join(" "))};
return b}();k=function(){var b,a;if(null==this.bean)return c("init: wait"),setTimeout(k,100);c("init: enter");moment.locale("ja");b=new m(this.bean);a=new ZoomSlider(function(a){return b.zoom(1+1.1*a)});new Toolbar(this.bean,{width:60,height:229,move:a.reloadOffset});this.gameManager=b;return c("init: leave")};$(function(){return k()});this.search=function(b){if(window.gameManager)return gameManager.search(b)}}).call(this);
