(function(){var p,k,s,v,m,q,w,h,x,y,n,t,z,A,r,u,B,C,D,l,E,g;h=function(){return console.log.apply(console,arguments)};this.tr=function(a){return i18nBean.tr(a)};q=function(a){return cacheBean.cacheImage(a)};y=function(a,b){var e,c;for(e in a)delete a[e];c=[];for(e in b)c.push(a[e]=b[e]);return c};A=function(a){return q("http://153.121.54.194/upload/image/"+a.id+"."+a.suffix)};z=function(a,b){null==b&&(b=128);return a?b?q("http://media.getchute.com/media/"+a+"/"+b+"x"+b):q("http://media.getchute.com/media/"+
a):""};D=function(a){return null==a?"":bbcode.parse(linkify(_.escape(a.replace(/]\n/g,"]")))).replace(/<li><\/li>/g,"<li>")};t=function(a,b){var e;try{if("number"===(e=typeof a)||"string"===e)a*=1E3;return a?moment(a).format(b):""}catch(c){return""}};w=function(){return this.HAML_POST=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  .left\n    :if userAvatar\n      %img.img-circle.avatar(src="${userAvatar}")\n  .right\n    .head\n      .user(style="${userStyle}") ${userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    :if USER_NAME && USER_NAME != \'guest\'\n      .foot\n        .btn-group.like-group.fade-in\n          %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'")\n            %span.fa.fa-thumbs-up\n            %span.value = likeCount\n          %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'")\n            %span.fa.fa-thumbs-down\n            %span.value = dislikeCount\n        .btn-group.pull-right.fade-in\n          :if userName == USER_NAME\n            %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+
tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply').replace(/\$/g,"#"))};k=[];l=function(a){return HAML_POST({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:a.lang,userAvatar:z(a.userAvatar),content:D(a.content),createTime:t(a.createTime,"H:mm M/D/YY ddd"),updateTime:a.updateTime>a.createTime?t(a.updateTime,"H:mm M/D/YY ddd"):"",image:a.image?
{title:a.image.title,url:A(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0})};p=function(a){return $(".post[data-id="+a+"]")};n=function(a){return _.findWhere(k,{id:a})};x=function(a){return postEditBean.editPost(JSON.stringify(a))};E=function(a){return postInputBean.replyPost(a)};m=function(){return $(".post.post-new").each(function(){var a,b,e;b=$(this).removeClass("post-new");e=b.data("id");a=b.find("> .right > .foot");a.find(".btn-edit").click(function(){var a;(a=n(e))&&
x(a);return!1});a.find(".btn-reply").click(function(){E(e);return!1});a.find(".btn.like").click(function(){var c,d,f;(c=n(e))&&c.userName!==USER_NAME&&(c=a.find(".btn.dislike.selected"),c.length&&(c.removeClass("selected"),d=c.find(".value"),d.text(-1+Number(d.text()))),b=$(this),f=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:e,type:"like",value:f?0:1},success:function(a){return function(){b.toggleClass("selected");d=b.find(".value");
return d.text((f?-1:1)+Number(d.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var c,d,f;(c=n(e))&&c.userName!==USER_NAME&&(c=a.find(".btn.like.selected"),c.length&&(c.removeClass("selected"),d=c.find(".value"),d.text(-1+Number(d.text()))),b=$(this),f=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:e,type:"like",value:f?0:-1},success:function(a){return function(){b.toggleClass("selected");d=b.find(".value");
return d.text((f?-1:1)+Number(d.text()))}}(this)}));return!1})})};s=function(a){var b,e,c,d,f,g;k.push.apply(k,a);e=function(){var b,e,d;d=[];b=0;for(e=a.length;b<e;b++)c=a[b],"post"===c.type&&d.push(l(c));return d}().join("");$(".topic > .posts").append(e);d=function(){var b,e,d;d=[];b=0;for(e=a.length;b<e;b++)c=a[b],"reply"===c.type&&d.push(c);return d}();if(d.length)for(d=_.sortBy(d,function(a){return a.createTime}),f=0,g=d.length;f<g;f++)c=d[f],b=p(c.replyId),b.length?(e=l(c),b.children(".reply").append(e)):
h("addPosts: error: post lost");return m()};r=function(){return $(".post.post-new").effect("highlight",1500)};g=function(a){return $("#spin").spin(a?"large":!1)};C=function(){g(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",asc:!1,limit:20},error:function(){g(!1);return growl.warn(tr("Internet error"))},success:function(a){g(!1);return a.length?s(a):growl.warn(tr("Internet error"))}})};B=function(){g(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",
asc:!1,first:k.length,limit:20},error:function(){g(!1);return growl.warn(tr("Internet error"))},success:function(a){g(!1);return a.length?s(a):growl(tr("No more"))}})};v=function(){return $(".topic > .foot > .btn-more").click(function(){var a;a=$(this);a.data("locked")||(a.data("lock",!0),B(),a.data("lock",!1));return!1})};this.READY=!1;this.addPost=function(a){var b;k.push(a);return"post"===a.type?(a=l(a),$(a).prependTo(".topic > .posts"),r(),m()):"reply"===a.type?(b=p(a.replyId),b.length?(a=l(a),
$(a).appendTo(b.children(".reply")),r(),m()):h("addPost: error: post lost")):h("addPost: error: unknown post type")};this.updatePost=function(a){var b;if(b=n(a.id))if(y(b,a),b=p(a.id),b.length){a=$(l(a));a.children(".reply").replaceWith(b.children(".reply"));b.replaceWith(a);r();m();return}return h("updatePost: error: post lost")};u=function(){if(null==this.i18nBean)return h("init: wait"),setTimeout(u,100);h("init: enter");moment.locale("ja");w();v();C();this.READY=!0;return h("init: leave")};$(function(){return u()})}).call(this);
