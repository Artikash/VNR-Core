(function(){var p,r,h,s,v,n,w,k,x,t,q,u,y,z,m,A,l;k=function(){return console.log.apply(console,arguments)};r=document.title;w=function(){return this.HAML_POST=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  .left\n    :if userAvatarUrl\n      %img.img-circle.avatar(src="${userAvatarUrl}")\n  .right\n    .header\n      .user(style="${userStyle}") @${userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    :if USER_NAME && USER_NAME != \'guest\'\n      .footer\n        .btn-group.like-group.fade-in\n          %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'")\n            %span.fa.fa-thumbs-up\n            %span.value = likeCount\n          %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'")\n            %span.fa.fa-thumbs-down\n            %span.value = dislikeCount\n        .btn-group.pull-right.fade-in\n          :if userName == USER_NAME\n            %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+
tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply').replace(/\$/g,"#"))};h=[];m=function(a){return HAML_POST({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>a.createTime?
util.formatDate(a.updateTime):"",image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0})};p=function(a){return $(".post[data-id="+a+"]")};t=function(a){return _.findWhere(h,{id:a})};x=function(a){return postEditBean.editPost(JSON.stringify(a))};A=function(a){return postInputBean.replyPost(a)};n=function(){return $(".post.post-new").each(function(){var a,b,c,f;b=$(this).removeClass("post-new");f=b.data("id");c=t(f);a=b.find("> .right > .footer");
a.find(".btn-edit").click(function(){c&&x(c);return!1});a.find(".btn-reply").click(function(){A(f);return!1});(null!=c&&c.likeCount||null!=c&&c.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var e,d,g;c&&c.userName!==USER_NAME&&(e=a.find(".btn.dislike.selected"),e.length&&(e.removeClass("selected"),d=e.find(".value"),d.text(-1+Number(d.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),g=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,
password:USER_PASSWORD,targetType:"post",targetId:f,type:"like",value:g?0:1},success:function(a){return function(){b.toggleClass("selected");d=b.find(".value");return d.text((g?-1:1)+Number(d.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var e,d,g;c&&c.userName!==USER_NAME&&(e=a.find(".btn.like.selected"),e.length&&(e.removeClass("selected"),d=e.find(".value"),d.text(-1+Number(d.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),g=b.hasClass("selected"),
ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:f,type:"like",value:g?0:-1},success:function(a){return function(){b.toggleClass("selected");d=b.find(".value");return d.text((g?-1:1)+Number(d.text()))}}(this)}));return!1})})};s=function(a){var b,c,f,e,d,g;h.push.apply(h,a);document.title=""+r+" ("+h.length+")";c=function(){var b,d,c;c=[];b=0;for(d=a.length;b<d;b++)f=a[b],"post"===f.type&&c.push(m(f));return c}().join("");$(".topic > .posts").append(c);e=function(){var b,
d,c;c=[];b=0;for(d=a.length;b<d;b++)f=a[b],"reply"===f.type&&c.push(f);return c}();if(e.length)for(e=_.sortBy(e,function(a){return a.createTime}),d=0,g=e.length;d<g;d++)f=e[d],b=p(f.replyId),b.length?(c=m(f),b.children(".reply").append(c)):k("addPosts: error: post lost");return n()};q=function(){return $(".post.post-new").effect("highlight",1500)};l=function(a){return $("#spin").spin(a?"large":!1)};z=function(){l(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",asc:!1,limit:20},
error:function(){l(!1);return growl.warn(tr("Internet error"))},success:function(a){l(!1);return a.length?s(a):growl.warn(tr("Internet error"))}})};y=function(){l(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",asc:!1,first:h.length,limit:20},error:function(){l(!1);return growl.warn(tr("Internet error"))},success:function(a){l(!1);return a.length?s(a):growl(tr("No more"))}})};v=function(){return $(".topic > .footer > .btn-more").click(function(){var a;a=$(this);a.data("locked")||
(a.data("lock",!0),y(),a.data("lock",!1));return!1})};this.READY=!1;this.addPost=function(a){var b;h.push(a);document.title=""+r+" ("+h.length+")";return"post"===a.type?(a=m(a),$(a).prependTo(".topic > .posts"),q(),n()):"reply"===a.type?(b=p(a.replyId),b.length?(a=m(a),$(a).appendTo(b.children(".reply")),q(),n()):k("addPost: error: post lost")):k("addPost: error: unknown post type")};this.updatePost=function(a){var b;if(b=t(a.id))if(util.fillObject(b,a),b=p(a.id),b.length){a=$(m(a));a.children(".reply").replaceWith(b.children(".reply"));
b.replaceWith(a);q();n();return}return k("updatePost: error: post lost")};u=function(){if(null==this.i18nBean)return k("init: wait"),setTimeout(u,100);k("init: enter");moment.locale("ja");w();v();z();this.READY=!0;return k("init: leave")};$(function(){return u()})}).call(this);
