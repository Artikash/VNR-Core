(function(){var m,k,p,s,n,f,t,g,u,v,h,q,w,x,r,y,z,A,l,B,c;g=function(){return console.log.apply(console,arguments)};this.tr=function(a){return i18nBean.tr(a)};f=function(a){return cacheBean.cacheImage(a)};v=function(a,b){var d,e;for(d in a)delete a[d];e=[];for(d in b)e.push(a[d]=b[d]);return e};x=function(a){return f("http://153.121.54.194/upload/image/"+a.id+"."+a.suffix)};w=function(a,b){null==b&&(b=128);return a?b?f("http://media.getchute.com/media/"+a+"/"+b+"x"+b):f("http://media.getchute.com/media/"+
a):""};A=function(a){return null==a?"":bbcode.parse(linkify(_.escape(a.replace(/]\n/g,"]")))).replace(/<li><\/li>/g,"<li>")};q=function(a,b){var d;try{if("number"===(d=typeof a)||"string"===d)a*=1E3;return a?moment(a).format(b):""}catch(e){return""}};t=function(){return this.HAML_POST=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  .left\n    :if userAvatar\n      %img.img-circle.avatar(src="${userAvatar}")\n  .right\n    .head\n      .user(style="${userStyle}") ${userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    .foot\n      .btn-group.pull-right.fade-in\n        :if userName == USER_NAME\n          %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+
tr("Edit")+'") '+tr("Edit")+'\n        %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply\n%hr').replace(/\$/g,"#"))};k=[];l=function(a){return HAML_POST({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:a.lang,userAvatar:w(a.userAvatar),content:A(a.content),createTime:q(a.createTime,
"H:mm M/D/YY ddd"),updateTime:a.updateTime>a.createTime?q(a.updateTime,"H:mm M/D/YY ddd"):"",image:a.image?{title:a.image.title,url:x(a.image)}:null})};m=function(a){return $(".post[data-id="+a+"]")};h=function(a){return _.findWhere(k,{id:a})};u=function(a){return postEditBean.editPost(JSON.stringify(a))};B=function(a){return alert("reply")};n=function(){return $(".post.post-new").each(function(){var a,b;a=$(this).removeClass("new");b=a.data("id");a=a.find("> .right > .foot");a.find(".btn-edit").click(function(){var a;
if(a=h(b))return u(a)});return a.find(".btn-reply").click(function(){var a;if(a=h(b))return B(a)})})};p=function(a){var b,d,e,c,f,h;k.push.apply(k,a);d=function(){var b,d,c;c=[];b=0;for(d=a.length;b<d;b++)e=a[b],"post"===e.type&&c.push(l(e));return c}().join("");$(".topic > .posts").append(d);c=function(){var b,d,c;c=[];b=0;for(d=a.length;b<d;b++)e=a[b],"reply"===e.type&&c.push(e);return c}();if(c.length)for(c=_.sortBy(c,function(a){return a.createTime}),f=0,h=c.length;f<h;f++)e=c[f],b=m(e.replyId),
b.length?(d=l(e),b.children(".reply").append(d)):g("addPosts: error: post lost");return n()};c=function(a){return $("#spin").spin(a?"large":!1)};z=function(){c(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"createTime",asc:!1,limit:20},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);return a.length?p(a):growl.warn(tr("Internet error"))}})};y=function(){c(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"createTime",asc:!1,first:k.length,
limit:20},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);return a.length?p(a):growl(tr("No more"))}})};s=function(){return $(".topic > .foot > .btn-more").click(function(){var a;a=$(this);a.data("locked")||(a.data("lock",!0),y(),a.data("lock",!1));return!1})};this.READY=!1;this.addPost=function(a){var b;k.push(a);return"post"===a.type?(b=l(a),$(b).prependTo(".topic > .posts").effect("highlight",1500),n()):"reply"===a.type?(a=m(a.replyId),a.length?(b=l(it),
$(b).appendTo(a.children(".reply")).effect("highlight",1500),n()):g("addPost: error: post lost")):g("addPost: error: unknown post type")};this.updatePost=function(a){var b,c;if(b=h(a.id))if(v(b,a),b=m(a.id),b.length){c=b.children(".reply");b.replaceWith(l(a));b=m(a.id);b.children("reply").replaceWith(c);b.effect("highlight",1500);n();return}return g("updatePost: error: post lost")};r=function(){if(null==this.i18nBean)return g("init: wait"),setTimeout(r,100);g("init: enter");moment.locale("ja");t();
s();z();this.READY=!0;return g("init: leave")};$(function(){return r()})}).call(this);
