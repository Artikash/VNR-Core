(function(){var m,r,k,e,s,n,t,g,f,p,u,v,q,w,x,y,l,c,z;f=function(){return console.log.apply(console,arguments)};this.tr=function(a){return i18nBean.tr(a)};g=function(a){return cacheBean.cacheImage(a)};v=function(a){return g("http://153.121.54.194/upload/image/"+a.id+"."+a.suffix)};u=function(a,b){null==b&&(b=128);return a?b?g("http://media.getchute.com/media/"+a+"/"+b+"x"+b):g("http://media.getchute.com/media/"+a):""};y=function(a){return null==a?"":bbcode.parse(linkify(_.escape(a.replace(/]\n/g,
"]")))).replace(/<li><\/li>/g,"<li>")};p=function(a,b){var d;try{if("number"===(d=typeof a)||"string"===d)a*=1E3;return a?moment(a).format(b):""}catch(f){return""}};r=Haml('.post(data-id="#{id}" data-type="#{type}")\n  .left\n    :if userAvatar\n      %img.img-circle.avatar(src="#{userAvatar}")\n  .right\n    .head\n      .user(style="#{userStyle}") #{userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    .foot\n    :if image\n      .image\n        %a(href="#{image.url}" title="#{image.title}")\n          %img(src="#{image.url}" alt="#{image.title}")\n  .reply\n%hr');
l=function(a){return r({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:a.lang,userAvatar:u(a.userAvatar),content:y(a.content),createTime:p(a.createTime,"H:mm M/D/YY ddd"),updateTime:a.updateTime>a.createTime?p(a.updateTime,"H:mm M/D/YY ddd"):"",image:a.image?{title:a.image.title,url:v(a.image)}:null})};m=function(a){return $(".post[data-id="+a+"]")};n=function(a){var b,d,h,c,e,k,g;d=function(){var b,c,d;d=[];b=0;for(c=a.length;b<c;b++)h=a[b],"post"===h.type&&
d.push(l(h));return d}().join("");$(".topic > .posts").append(d);c=function(){var b,d,c;c=[];b=0;for(d=a.length;b<d;b++)h=a[b],"reply"===h.type&&c.push(h);return c}();if(c.length){c=_.sortBy(c,function(a){return a.createTime});g=[];e=0;for(k=c.length;e<k;e++)h=c[e],b=m(h.replyId),b.length?(d=l(h),g.push(b.children(".reply").append(d))):g.push(f("addPosts: error: post lost"));return g}};s=function(a){var b;return"post"===a.type?(b=l(a),$(b).appendTo(".topic > .posts").effect("highlight",1500)):"reply"===
a.type?(a=m(a.replyId),a.length?(b=l(it),$(b).appendTo(a.children(".reply")).effect("highlight",1500)):f("addPost: error: post lost")):f("addPost: error: unknown post type")};z=function(a){var b,c;b=m(a.id);return b.length?(c=b.children(".reply"),b.replaceWith(l(a)),b=m(a.id),b.children("reply").replaceWith(c),b.effect("highlight",1500)):f("updatePost: error: post lost")};c=function(a){return $("#spin").spin(a?"large":!1)};e=0;x=function(){c(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,
sort:"createTime",asc:!1,limit:20},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);return a.length?(e+=a.length,n(a)):growl.warn(tr("Internet error"))}})};w=function(){c(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"createTime",asc:!1,first:e,limit:20},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);return a.length?(e+=a.length,n(a)):growl(tr("No more"))}})};t=function(){return $(".topic > .foot > .btn-more").click(function(){var a;
a=$(this);a.data("locked")||(a.data("lock",!0),w(),a.data("lock",!1));return!1})};k=!1;q=function(){if(null==this.i18nBean)return f("init: wait"),setTimeout(q,100);f("init: enter");moment.locale("ja");this.TOPIC_ID=$(".topic").data("id");t();x();k=!0;return f("init: leave")};$(function(){return q()});this.addPostData=function(a){var b;if(k)try{return b=JSON.parse(a),s(b)}catch(c){return f("addPost: invalid json",c)}};this.updatePostData=function(a){var b;if(k)try{return b=JSON.parse(a),z(b)}catch(c){return f("addPost: invalid json",
c)}}}).call(this);
