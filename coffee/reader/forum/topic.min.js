(function(){var k,n,p,q,l,r,t=[].indexOf||function(a){for(var d=0,c=this.length;d<c;d++)if(d in this&&this[d]===a)return d;return-1},g=function(a,d){return function(){return a.apply(d,arguments)}};p=function(){Array.prototype.unshift.call(arguments,"topic:");return console.log.apply(console,arguments)};k=null;n=function(){return k=Haml(('.topic(data-id="${id}" data-type="${type}" data-subject-id="${subjectId}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+
tr("Avatar")+'")\n  .right\n    .title.text-info(title="'+tr("Title")+'") ${title}\n    .header.line\n      .type.text-warning = typeName\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      :if createTime\n        .time.text-minor(title="${createTimeString}") = createTime.fromNow()\n      .lang = lang\n      :if updateTime\n        .time.text-success(title="${updateTimeString}") = updateTime.fromNow()\n      :if scores\n        .score\n          .item.text-danger\n            '+
tr("Score")+": ${'overall' in scores ? scores.overall : '-'}/10\n          .item.text-warning\n            H: ${'ecchi' in scores ? scores.ecchi : '-'}/10\n    :if gameTitle\n      .game-title\n        %a.pull-right.link-game.btn.btn-link(title=\""+tr("Show")+'")\n          \u2013\u2013 ${gameTitle}\n    :if content\n      .content.bbcode = content\n    .footer\n      .btn-group.like-group.fade-in\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+
tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group.fade-in.pull-right\n        :if\n          %a.btn-reply.btn.btn-link.btn-sm(role="button" title="'+tr("Reply")+'")\n            '+tr("Reply")+"\n            :if postCount\n              = ' (' + postCount + ')'\n        :if editable\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn-add.btn.btn-link.btn-sm(role="button" title="'+
tr("Add")+'") '+tr("Add")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,"#"))};r=function(a){var d,c,b;d=b=null;a.createTime&&(d=moment(1E3*a.createTime));a.updateTime>a.createTime&&(b=moment(1E3*a.updateTime));return k({id:a.id,type:a.type,typeName:util.getTopicTypeName(a.type),editable:a.userName===USER_NAME&&(c=a.type,0<=t.call(util.TOPIC_TYPES,c)),lang:util.getLangName(a.lang),subjectId:a.subjectId,
gameTitle:"game"===a.subjectType?a.subjectTitle:"",userAvatarUrl:util.getAvatarUrl(a.userAvatar),userStyle:a.userColor?"color:"+a.userColor:"",title:a.title,content:util.renderContent(a.content),createTime:d,updateTime:b,createTimeString:util.formatDate(d),updateTimeString:util.formatDate(b),userName:a.userName,image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,postCount:a.postCount,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,scores:a.scores})};l=function(a,d){return postInputBean.newPost(a,
d)};q=function(a){return topicEditBean.editTopic(JSON.stringify(a))};this.topicjs={init:function(){return n()},Topic:function(){function a(a,c){this.id=a;this.$sel=c.$container;this.show=g(this.show,this);this.updateTopic=g(this.updateTopic,this);this.showTopic=g(this.showTopic,this);this._highlightTopic=g(this._highlightTopic,this);this._bindTopic=g(this._bindTopic,this);this.topic={}}a.prototype._bindTopic=function(){var a,c,b,m,e,g;b=this.$sel.children(".topic");e=this.topic;g=b.data("id");m=b.data("subject-id");
c=b.find("> .right > .header");a=b.find("> .right > .footer");e.finished&&b.addClass("finished");b.find("a.link-game").click(function(){m&&mainBean.showGame(m);return!1});c.find("a.user").click(function(){null!=e&&e.userName&&mainBean.showUser(e.userName);return!1});a.find(".btn-edit").click(function(){q(e);return!1});a.find(".btn-add").click(function(){l(g,"topic");return!1});a.find(".btn-reply").click(function(){l(g,"post");return!1});(null!=e&&e.likeCount||null!=e&&e.dislikeCount)&&a.find(".like-group").removeClass("fade-in");
a.find(".btn.like").click(function(){var b,c,f,h;e&&USER_NAME&&USER_NAME!==e.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),c=$(this),c.parent(".like-group").removeClass("fade-in"),h=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:g,type:"like",value:h?0:1},success:function(a){return function(){c.toggleClass("selected");f=c.find(".value");return f.text((h?
-1:1)+Number(f.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,c,f,h;e&&USER_NAME&&USER_NAME!==e.userName&&(b=a.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),c=$(this),c.parent(".like-group").removeClass("fade-in"),h=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:g,type:"like",value:h?0:-1},success:function(a){return function(){c.toggleClass("selected");
f=c.find(".value");return f.text((h?-1:1)+Number(f.text()))}}(this)}));return!1})};a.prototype._highlightTopic=function(){return this.$sel.effect("highlight",1500)};a.prototype.showTopic=function(a){this.topic=a;return this.updateTopic(this.topic,!1)};a.prototype.updateTopic=function(a,c){var b;null==c&&(c=!0);if(a.id!==this.topic.id)p("different topic id");else return this.topic=a,b=r(this.topic),this.$sel.html(b),c&&this._highlightTopic(),this._bindTopic()};a.prototype.show=function(a){var c,b;
b=a.success;c=this;spin(!0);return rest.forum.query("topic",{data:{id:this.id},error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(a){spin(!1);if(a.id)return c.showTopic(a),"function"===typeof b?b():void 0}})};return a}()}}).call(this);
