(function(){var h,l,k,m,g,c=function(a,b){return function(){return a.apply(b,arguments)}};k=function(){Array.prototype.unshift.call(arguments,"topics:");return console.log.apply(console,arguments)};h=null;l=function(){return h=Haml(('.topic.topic-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+'")\n  .right\n    .header.line\n      .item.type.text-warning = tr(type)\n      %span.pull-right\n        %a.item(href="javascript:" style="${userStyle}") @${userName}\n        .item.text-minor = lang\n        .item.text-minor = createTime\n        .item.text-success = updateTime\n    %a.item.title(title="'+
tr("Browse")+"\") ${title}\n    :if scores\n      .score\n        .pp-table.dock\n          :if scores.overall != undefined\n            .pp-row(data-type='overall')\n              .pp-name "+tr("Overall")+":\n              .pp-value ${scores.overall}/10\n          :if scores.ecchi != undefined\n            .pp-row(data-type='ecchi')\n              .pp-name "+tr("Ecchi")+':\n              .pp-value ${scores.ecchi}/10\n    .footer\n      .btn-group.like-group\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group\n        %a.btn-reply.btn.btn-link.btn-sm(role="button" title="'+tr("Reply")+'")\n          '+tr("Reply")+"\n          :if postCount\n            = ' (' + postCount + ')'\n        :if userName == USER_NAME\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+
tr("Edit")+'") '+tr("Edit")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,"#"))};g=function(a){var b;if(b=a.subupload)b.ignoreCount=(b.totalCount||0)-(b.createCount||0)-(b.updateCount||0)-(b.errorCount||0),b.createTimeString=util.formatDate(b.createTime),b.updateTimeString=util.formatDate(b.updateTime);return h({id:a.id,type:a.type,lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),
userStyle:a.userColor?"color:"+a.userColor:"",title:a.title,content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>a.createTime?util.formatDate(a.updateTime):"",userName:a.userName,image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,postCount:a.postCount,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,scores:a.scores,su:b})};m=function(a){return topicEditBean.editTopic(JSON.stringify(a))};this.topicsjs={init:function(){return l()},
TopicList:function(){function a(b){this.$sel=b.container;this.$more=b.more;this.subjectId=b.subjectId;this.more=c(this.more,this);this.show=c(this.show,this);this.bind=c(this.bind,this);this.updateTopic=c(this.updateTopic,this);this.addTopic=c(this.addTopic,this);this._highlightNewTopics=c(this._highlightNewTopics,this);this.addTopics=c(this.addTopics,this);this._bindNewTopics=c(this._bindNewTopics,this);this.getTopic=c(this.getTopic,this);this.$getTopic=c(this.$getTopic,this);this.topics=[];this.bind();
this.show()}a.prototype.subjectType="game";a.prototype.$getTopic=function(b){return this.$sel.find(".topic[data-id="+b+"]")};a.prototype.getTopic=function(b){return _.findWhere(this.topics,{id:b})};a.prototype._bindNewTopics=function(){var b;b=this;return this.$sel.find(".topic.topic-new").each(function(){var a,c,e,d,g;e=$(this).removeClass("topic-new");g=e.data("id");d=b.getTopic(g);c=e.find("> .right > .header");a=e.find("> .right > .footer");c.find("a.user").click(function(){null!=d&&d.userName&&
mainBean.showUser(d.userName);return!1});a.find(".btn-edit").click(function(){d&&m(d);return!1});a.find(".btn-reply").click(function(){return!1});(null!=d&&d.likeCount||null!=d&&d.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var b,c,f,e;d&&USER_NAME&&USER_NAME!==d.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),c=$(this),c.parent(".like-group").removeClass("fade-in"),
e=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:g,type:"like",value:e?0:1},success:function(b){return function(){c.toggleClass("selected");f=c.find(".value");return f.text((e?-1:1)+Number(f.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,c,f,e;d&&USER_NAME&&USER_NAME!==d.userName&&(b=a.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),c=
$(this),c.parent(".like-group").removeClass("fade-in"),e=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:g,type:"like",value:e?0:-1},success:function(b){return function(){c.toggleClass("selected");f=c.find(".value");return f.text((e?-1:1)+Number(f.text()))}}(this)}));return!1})})};a.prototype.addTopics=function(b){var a;this.topics.push.apply(this.topics,b);var c,e,d;d=[];c=0;for(e=b.length;c<e;c++)a=b[c],"review"!==a.type&&d.push(g(a));
b=d.join("");this.$sel.append(b);return this._bindNewTopics()};a.prototype._highlightNewTopics=function(){return this.$sel.find(".topic.topic-new").effect("highlight",1500)};a.prototype.addTopic=function(b){this.topics.push(b);return"review"!==b.type?(b=g(b),this.$sel.prepend(b),this._highlightNewTopics(),this._bindNewTopics()):k("addTopic: error: unknown topic type")};a.prototype.updateTopic=function(b){var a;if(a=this.getTopic(b.id))if(util.fillObject(a,b),a=this.$getTopic(b.id),a.length){b=g(b);
a.replaceWith(b);this._highlightNewTopics();this._bindNewTopics();return}return k("updateTopic: error: topic lost")};a.prototype.bind=function(){var b;b=this;return this.$more.hide().click(function(){var a;a=$(this);a.data("locked")||(a.data("lock",!0),b.more(),a.data("lock",!1));return!1})};a.prototype.show=function(){var b;b=this;spin(!0);return rest.forum.list("topic",{data:{subjectId:this.subjectId,subjectType:this.subjectType,sort:"updateTime",asc:!1,complete:!0,limit:10},error:function(){spin(!1);
return growl.warn(tr("Internet error"))},success:function(a){spin(!1);return a.length?(b.addTopics(a),b.$more.show()):growl.warn(tr("Internet error"))}})};a.prototype.more=function(){var a;a=this;spin(!0);return rest.forum.list("topic",{data:{subjectId:this.subjectId,subjectId:this.subjectType,sort:"updateTime",asc:!1,complete:!0,first:this.topics.length,limit:20},error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(c){spin(!1);return c.length?a.addTopics(c):growl(tr("No more"))}})};
return a}()}}).call(this);
