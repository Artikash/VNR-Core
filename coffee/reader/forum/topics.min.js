(function(){var l,m,n,p,h,e=function(a,b){return function(){return a.apply(b,arguments)}};n=function(){Array.prototype.unshift.call(arguments,"topics:");return console.log.apply(console,arguments)};l=null;m=function(){return l=Haml(('.topic.topic-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+'")\n  .right\n    .header.line\n      .type.text-warning = tr(type)\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      :if createTime\n        .time.text-minor(title="${createTimeString}") = createTime.fromNow()\n      .lang = lang\n      :if updateTime\n        .time.text-success(title="${updateTimeString}") = updateTime.fromNow()\n      :if scores\n        .score\n          .item.text-danger\n            '+
tr("Score")+": ${scores.overall != undefined ? scores.overall : '-'}/10\n          .item.text-warning\n            H: ${scores.ecchi != undefined ? scores.ecchi : '-'}/10\n    .line.title\n      %a(title=\""+tr("Show")+'") ${title}\n      :if gameTitle\n        %a.pull-right.link-game(data-id="${subjectId}" title="'+tr("Show")+'")\n          \u30fc\u30fc ${gameTitle}\n    :if content\n      .content.bbcode = content\n    .footer\n      .btn-group.like-group.fade-in\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group.fade-in.pull-right\n        %a.btn-reply.btn.btn-link.btn-sm(role="button" title="'+tr("Reply")+'")\n          '+tr("Reply")+"\n          :if postCount\n            = ' (' + postCount + ')'\n        :if userName == USER_NAME\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+
tr("Edit")+'") '+tr("Edit")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,"#"))};h=function(a,b){var k,c,d;k=d=null;a.createTime&&(k=moment(1E3*a.createTime));a.updateTime>a.createTime&&(d=moment(1E3*a.updateTime));if(c=a.subupload)c.ignoreCount=(c.totalCount||0)-(c.createCount||0)-(c.updateCount||0)-(c.errorCount||0),c.createTimeString=util.formatDate(c.createTime),c.updateTimeString=
util.formatDate(c.updateTime);return l({id:a.id,type:a.type,lang:util.getLangName(a.lang),subjectId:a.subjectId,gameTitle:"game"===a.subjectType?a.subjectTitle:"",userAvatarUrl:util.getAvatarUrl(a.userAvatar),userStyle:a.userColor?"color:"+a.userColor:"",title:a.title,content:b?util.renderContent(a.content):"",createTime:k,updateTime:d,createTimeString:util.formatDate(k),updateTimeString:util.formatDate(d),userName:a.userName,image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,
postCount:a.postCount,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,scores:a.scores,su:c})};p=function(a){return topicEditBean.editTopic(JSON.stringify(a))};this.topicsjs={init:function(){return m()},TopicList:function(){function a(b){this.$sel=b.container;this.$more=b.more;this.complete=b.complete;b=b.search;this.more=e(this.more,this);this.show=e(this.show,this);this.bind=e(this.bind,this);this.updateTopic=e(this.updateTopic,this);this.addTopic=e(this.addTopic,this);this._highlightNewTopics=
e(this._highlightNewTopics,this);this.addTopics=e(this.addTopics,this);this._bindNewTopics=e(this._bindNewTopics,this);this.getTopic=e(this.getTopic,this);this.$getTopic=e(this.$getTopic,this);this.topics=[];this.search={asc:!1,sort:"updateTime",complete:!0};null!=b&&_.extend(this.search,b);this.bind();this.show()}a.prototype.$getTopic=function(b){return this.$sel.find(".topic[data-id="+b+"]")};a.prototype.getTopic=function(b){return _.findWhere(this.topics,{id:b})};a.prototype._bindNewTopics=function(){var b;
b=this;return this.$sel.find(".topic.topic-new").each(function(){var a,c,d,f,e;d=$(this).removeClass("topic-new");e=d.data("id");f=b.getTopic(e);c=d.find("> .right > .header");a=d.find("> .right > .footer");d.find("a.link-game").click(function(){mainBean.showGame(this.dataset.id);return!1});c.find("a.user").click(function(){null!=f&&f.userName&&mainBean.showUser(f.userName);return!1});a.find(".btn-edit").click(function(){f&&p(f);return!1});a.find(".btn-reply").click(function(){return!1});(null!=f&&
f.likeCount||null!=f&&f.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var b,c,d,g;f&&USER_NAME&&USER_NAME!==f.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),d=b.find(".value"),d.text(-1+Number(d.text()))),c=$(this),c.parent(".like-group").removeClass("fade-in"),g=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:e,type:"like",value:g?0:1},success:function(b){return function(){c.toggleClass("selected");
d=c.find(".value");return d.text((g?-1:1)+Number(d.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,c,d,g;f&&USER_NAME&&USER_NAME!==f.userName&&(b=a.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),d=b.find(".value"),d.text(-1+Number(d.text()))),c=$(this),c.parent(".like-group").removeClass("fade-in"),g=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:e,type:"like",value:g?0:-1},success:function(b){return function(){c.toggleClass("selected");
d=c.find(".value");return d.text((g?-1:1)+Number(d.text()))}}(this)}));return!1})})};a.prototype.addTopics=function(b){var a;this.topics.push.apply(this.topics,b);var c,d,f;f=[];c=0;for(d=b.length;c<d;c++)a=b[c],f.push(h(a,this.complete));b=f.join("");this.$sel.append(b);return this._bindNewTopics()};a.prototype._highlightNewTopics=function(){return this.$sel.find(".topic.topic-new").effect("highlight",1500)};a.prototype.addTopic=function(b){this.topics.push(b);b=h(b,this.complete);this.$sel.prepend(b);
this._highlightNewTopics();return this._bindNewTopics()};a.prototype.updateTopic=function(b){var a;if(a=this.getTopic(b.id))if(util.fillObject(a,b),a=this.$getTopic(b.id),a.length){b=h(b,this.complete);a.replaceWith(b);this._highlightNewTopics();this._bindNewTopics();return}return n("updateTopic: error: topic lost")};a.prototype.bind=function(){var a;a=this;return this.$more.hide().click(function(){var e;e=$(this);e.data("locked")||(e.data("lock",!0),a.more(),e.data("lock",!1));return!1})};a.prototype.show=
function(){var a;a=this;spin(!0);this.search.limit=5;return rest.forum.list("topic",{data:this.search,error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(e){spin(!1);if(e.length)return a.addTopics(e),a.$more.show()}})};a.prototype.more=function(){var a;a=this;spin(!0);this.search.first=this.topics.length;this.search.limit=10;return rest.forum.list("topic",{data:this.search,error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(e){spin(!1);
return e.length?a.addTopics(e):growl(tr("No more"))}})};return a}()}}).call(this);
