(function(){var l,n,p,q,k,r=[].indexOf||function(a){for(var c=0,m=this.length;c<m;c++)if(c in this&&this[c]===a)return c;return-1},b=function(a,c){return function(){return a.apply(c,arguments)}};p=function(){Array.prototype.unshift.call(arguments,"topics:");return console.log.apply(console,arguments)};l=null;n=function(){return l=Haml(('.topic.topic-new(data-id="${id}" data-type="${type}" data-subject-id="${subjectId}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+
tr("Avatar")+'")\n  .right\n    .header.line\n      .index.text-minor ${index}.\n      .type.text-warning = typeName\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      :if createTime\n        .time.text-minor(title="${createTimeString}") = createTime.fromNow()\n      .lang = lang\n      :if updateTime\n        .time.text-success(title="${updateTimeString}") = updateTime.fromNow()\n      :if scores\n        .score\n          .item.text-danger\n            '+tr("Score")+": ${'overall' in scores ? scores.overall : '-'}/10\n          .item.text-warning\n            H: ${'ecchi' in scores ? scores.ecchi : '-'}/10\n    .line.title\n      %a.btn.btn-link.link-topic(title=\""+
tr("Show")+'") ${title}\n      :if gameTitle\n        %a.pull-right.link-game.btn.btn-link(title="'+tr("Show")+'")\n          \u2013\u2013 ${gameTitle}\n    :if content\n      .content.bbcode = content\n    .footer\n      .btn-group.like-group.fade-in\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group.fade-in.pull-right\n        %a.btn-reply.btn.btn-link.btn-sm.link-topic(role="button" title="'+
tr("Reply")+'")\n          '+tr("Reply")+"\n          :if postCount\n            = ' (' + postCount + ')'\n        :if editable\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+tr("Edit")+'") '+tr("Edit")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,"#"))};k=function(a,c,m){var d,f,b;d=b=null;a.createTime&&(d=moment(1E3*a.createTime));a.updateTime>a.createTime&&(b=
moment(1E3*a.updateTime));return l({index:c+1,id:a.id,type:a.type,typeName:util.getTopicTypeName(a.type),editable:a.userName===USER_NAME&&(f=a.type,0<=r.call(util.TOPIC_TYPES,f)),lang:util.getLangName(a.lang),subjectId:a.subjectId,gameTitle:"game"===a.subjectType?a.subjectTitle:"",userAvatarUrl:util.getAvatarUrl(a.userAvatar),userStyle:a.userColor?"color:"+a.userColor:"",title:a.title,content:m?util.renderContent(a.content):"",createTime:d,updateTime:b,createTimeString:util.formatDate(d),updateTimeString:util.formatDate(b),
userName:a.userName,image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,postCount:a.postCount,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,scores:a.scores})};q=function(a){return topicEditBean.editTopic(JSON.stringify(a))};this.topicsjs={init:function(){return n()},TopicList:function(){function a(c){this.$container=c.$container;this.$more=c.$more;this.$newReview=c.$newReview;this.$userReview=c.$userReview;this.complete=c.complete;c=c.search;this._checkUserReview=b(this._checkUserReview,
this);this.findUserReview=b(this.findUserReview,this);this.more=b(this.more,this);this.show=b(this.show,this);this.bind=b(this.bind,this);this.updateTopic=b(this.updateTopic,this);this._addUserReview=b(this._addUserReview,this);this.addTopic=b(this.addTopic,this);this._highlightNewTopics=b(this._highlightNewTopics,this);this.addTopics=b(this.addTopics,this);this._bindNewTopics=b(this._bindNewTopics,this);this.getTopic=b(this.getTopic,this);this.$getTopic=b(this.$getTopic,this);this.$sel=this.$container;
null!=this.$userReview&&(this.$sel=this.$sel.add(this.$userReview));this.topics=[];this.search={asc:!1,sort:"updateTime",complete:!0};null!=c&&_.extend(this.search,c);this.bind()}a.prototype.$getTopic=function(c){return this.$sel.find(".topic[data-id="+c+"]")};a.prototype.getTopic=function(c){return _.findWhere(this.topics,{id:c})};a.prototype._bindNewTopics=function(){var c;c=this;return this.$sel.find(".topic.topic-new").each(function(){var a,d,b,g,e,h;b=$(this).removeClass("topic-new");h=b.data("id");
g=b.data("subject-id");e=c.getTopic(h);d=b.find("> .right > .header");a=b.find("> .right > .footer");b.find("a.link-game").click(function(){g&&mainBean.showGame(g);return!1});b.find("a.link-topic").click(function(){mainBean.showTopic(h);return!1});d.find("a.user").click(function(){null!=e&&e.userName&&mainBean.showUser(e.userName);return!1});a.find(".btn-edit").click(function(){e&&q(e);return!1});(null!=e&&e.likeCount||null!=e&&e.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var c,
b,d,f;e&&USER_NAME&&USER_NAME!==e.userName&&(c=a.find(".btn.dislike.selected"),c.length&&(c.removeClass("selected"),d=c.find(".value"),d.text(-1+Number(d.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),f=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:h,type:"like",value:f?0:1},success:function(c){return function(){b.toggleClass("selected");d=b.find(".value");return d.text((f?-1:1)+Number(d.text()))}}(this)}));return!1});
return a.find(".btn.dislike").click(function(){var c,b,d,f;e&&USER_NAME&&USER_NAME!==e.userName&&(c=a.find(".btn.like.selected"),c.length&&(c.removeClass("selected"),d=c.find(".value"),d.text(-1+Number(d.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),f=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:h,type:"like",value:f?0:-1},success:function(c){return function(){b.toggleClass("selected");d=b.find(".value");return d.text((f?
-1:1)+Number(d.text()))}}(this)}));return!1})})};a.prototype.addTopics=function(c){var a,b,f,g,e;e=[];a=f=0;for(g=c.length;f<g;a=++f)b=c[a],e.push(k(b,a+this.topics.length,this.complete));a=e.join("");this.topics.push.apply(this.topics,c);this.$container.append(a);return this._bindNewTopics()};a.prototype._highlightNewTopics=function(){return this.$sel.find(".topic.topic-new").effect("highlight",1500)};a.prototype.addTopic=function(c,a,b){var f;null==b&&(b=!0);f=k(c,this.topics.length,this.complete);
this.topics.push(c);(a||this.$container).prepend(f);b&&this._highlightNewTopics();return this._bindNewTopics()};a.prototype._addUserReview=function(c){return this.addTopic(c,this.$userReview,!1)};a.prototype.updateTopic=function(c){var a;if(a=this.getTopic(c.id))if(util.fillObject(a,c),a=this.$getTopic(c.id),a.length){c=k(c,this.complete);a.replaceWith(c);this._highlightNewTopics();this._bindNewTopics();return}return p("updateTopic: error: topic lost")};a.prototype.bind=function(){var a;a=this;return this.$more.hide().click(function(){var b;
b=$(this);b.data("locked")||(b.data("lock",!0),a.more(),b.data("lock",!1));return!1})};a.prototype.show=function(){var a;a=this;spin(!0);this.search.limit=5;return rest.forum.list("topic",{data:this.search,error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(b){var d;spin(!1);b.length&&(a.addTopics(b),0===b.length%5&&a.$more.show(),null!=a.$userReview&&a._checkUserReview());return null!=(d=a.$newReview)?d.show():void 0}})};a.prototype.more=function(){var a;a=this;spin(!0);
this.search.first=this.topics.length;this.search.limit=20;return rest.forum.list("topic",{data:this.search,error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(b){spin(!1);return b.length?a.addTopics(b):growl(tr("No more"))}})};a.prototype.findUserReview=function(){return _.findWhere(this.topics,{userName:USER_NAME})};a.prototype._checkUserReview=function(){var a,b;if(data.length&&USER_NAME&&this.$userReview){if(b=this.findUserReview())return this.$getTopic(b.id).appendTo(this.$userReview);
if("undefined"!==typeof SUBJECT_ID&&null!==SUBJECT_ID&&0===data.length%5)return a=this,spin(!0),rest.forum.list("topic",{data:{subjectId:SUBJECT_ID,subjectType:"game",userName:USER_NAME},error:function(){return spin(!1)},success:function(b){spin(!1);if(b.length)return a._addUserReview(b[0])}})}};return a}()}}).call(this);
