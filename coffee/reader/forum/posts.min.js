(function(){var q,r,p,s,n,t,g=function(a,b){return function(){return a.apply(b,arguments)}};p=function(){var a;a=Array.prototype.slice.call(arguments);a.unshift("posts:");return console.log.apply(console,a)};q=null;r=function(){return q=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+'")\n  .right\n    .header\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    :if USER_NAME && USER_NAME != \'guest\'\n      .footer\n        .btn-group.like-group.fade-in\n          %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'")\n            %span.fa.fa-thumbs-up\n            %span.value = likeCount\n          %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'")\n            %span.fa.fa-thumbs-down\n            %span.value = dislikeCount\n        .btn-group.pull-right.fade-in\n          :if userName == USER_NAME\n            %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+
tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply').replace(/\$/g,"#"))};n=function(a){return q({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>a.createTime?util.formatDate(a.updateTime):
"",image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0})};s=function(a){return postEditBean.editPost(JSON.stringify(a))};t=function(a){return postInputBean.replyPost(a)};this.postsjs={init:function(){return r()},PostList:function(){function a(b){var a,k;this.$sel=b.container;a=b.more;this.topicId=b.topicId;this.more=g(this.more,this);this.paint=g(this.paint,this);this.updatePost=g(this.updatePost,this);this.addPost=g(this.addPost,
this);this._highlightNewPosts=g(this._highlightNewPosts,this);this.addPosts=g(this.addPosts,this);this._bindNewPosts=g(this._bindNewPosts,this);this.getPost=g(this.getPost,this);this.$getPost=g(this.$getPost,this);this.posts=[];k=this;null!=a&&a.click(function(){var b;b=$(this);b.data("locked")||(b.data("lock",!0),k.more(),b.data("lock",!1));return!1});this.paint()}a.prototype.$getPost=function(b){return this.$sel.find(".post[data-id="+b+"]")};a.prototype.getPost=function(b){return _.findWhere(this.posts,
{id:b})};a.prototype._bindNewPosts=function(){var b;b=this;return this.$sel.find(".post.post-new").each(function(){var a,k,e,c,l;e=$(this).removeClass("post-new");l=e.data("id");c=b.getPost(l);k=e.find("> .right > .header");a=e.find("> .right > .footer");k.find("a.user").click(function(){null!=c&&c.userName&&mainBean.showUser(c.userName);return!1});a.find(".btn-edit").click(function(){c&&s(c);return!1});a.find(".btn-reply").click(function(){t(l);return!1});(null!=c&&c.likeCount||null!=c&&c.dislikeCount)&&
a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var b,h,f,m;c&&USER_NAME&&USER_NAME!==c.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),h=$(this),h.parent(".like-group").removeClass("fade-in"),m=h.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:l,type:"like",value:m?0:1},success:function(b){return function(){h.toggleClass("selected");
f=h.find(".value");return f.text((m?-1:1)+Number(f.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,h,f,m;c&&USER_NAME&&USER_NAME!==c.userName&&(b=a.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),h=$(this),h.parent(".like-group").removeClass("fade-in"),m=h.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:l,type:"like",value:m?0:-1},success:function(b){return function(){h.toggleClass("selected");
f=h.find(".value");return f.text((m?-1:1)+Number(f.text()))}}(this)}));return!1})})};a.prototype.addPosts=function(b){var a,k,e,c,l,g;this.posts.push.apply(this.posts,b);k=function(){var a,c,d;d=[];a=0;for(c=b.length;a<c;a++)e=b[a],"post"===e.type&&d.push(n(e));return d}().join("");this.$sel.append(k);c=function(){var a,c,d;d=[];a=0;for(c=b.length;a<c;a++)e=b[a],"reply"===e.type&&d.push(e);return d}();if(c.length)for(c=_.sortBy(c,function(a){return a.createTime}),l=0,g=c.length;l<g;l++)e=c[l],a=this.$getPost(e.replyId),
a.length?(k=n(e),a.children(".reply").append(k)):p("addPosts: error: post lost");return this._bindNewPosts()};a.prototype._highlightNewPosts=function(){return this.$sel.find(".post.post-new").effect("highlight",1500)};a.prototype.addPost=function(a){var d;this.posts.push(a);return"post"===a.type?(a=n(a),this.$sel.prepend(a),this._highlightNewPosts(),this._bindNewPosts()):"reply"===a.type?(d=this.$getPost(a.replyId),d.length?(a=n(a),d.children(".reply").append(a),this._highlightNewPosts(),this._bindNewPosts()):
p("addPost: error: post lost")):p("addPost: error: unknown post type")};a.prototype.updatePost=function(a){var d;if(d=this.getPost(a.id))if(util.fillObject(d,a),d=this.$getPost(a.id),d.length){a=$(n(a));a.children(".reply").replaceWith(d.children(".reply"));d.replaceWith(a);this._highlightNewPosts();this._bindNewPosts();return}return p("updatePost: error: post lost")};a.prototype.paint=function(){var a;a=this;spin(!0);return rest.forum.list("post",{data:{topic:this.topicId,sort:"updateTime",asc:!1,
limit:10},error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(d){spin(!1);return d.length?a.addPosts(d):growl.warn(tr("Internet error"))}})};a.prototype.more=function(){var a;a=this;spin(!0);return rest.forum.list("post",{data:{topic:this.topicId,sort:"updateTime",asc:!1,first:this.posts.length,limit:20},error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(d){spin(!1);return d.length?a.addPosts(d):growl(tr("No more"))}})};return a}()}}).call(this);
