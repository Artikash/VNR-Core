(function(){var l,p,m,q,h,r,c=function(a,b){return function(){return a.apply(b,arguments)}};m=function(){Array.prototype.unshift.call(arguments,"posts:");return console.log.apply(console,arguments)};l=null;p=function(){return l=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+'")\n  .right\n    .header\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      :if createTime\n        .time.text-minor(title="${createTimeString}") = createTime.fromNow()\n      .lang = lang\n      :if updateTime\n        .time.text-success(title="${updateTimeString}") = updateTime.fromNow()\n    .content.bbcode = content\n    :if USER_NAME\n      .footer\n        .btn-group.like-group.fade-in\n          %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'")\n            %span.fa.fa-thumbs-up\n            %span.value = likeCount\n          %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'")\n            %span.fa.fa-thumbs-down\n            %span.value = dislikeCount\n        .btn-group.pull-right.fade-in\n          :if userName == USER_NAME\n            %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+
tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply').replace(/\$/g,"#"))};h=function(a){var b,d;b=d=null;a.createTime&&(b=moment(1E3*a.createTime));a.updateTime>a.createTime&&(d=moment(1E3*a.updateTime));return l({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),content:util.renderContent(a.content),
createTime:b,updateTime:d,createTimeString:util.formatDate(b),updateTimeString:util.formatDate(d),image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0})};q=function(a){return postEditBean.editPost(JSON.stringify(a))};r=function(a,b){return postInputBean.replyPost(a,b)};this.postsjs={init:function(){return p()},PostList:function(){function a(b){this.$postContainer=b.$container;this.$topicContainer=b.$topicContainer;this.$more=
b.$more;this.topicId=b.topicId;this.search=b.search;this.more=c(this.more,this);this.show=c(this.show,this);this.refresh=c(this.refresh,this);this.bind=c(this.bind,this);this.updatePost=c(this.updatePost,this);this.addPost=c(this.addPost,this);this._highlightNewPosts=c(this._highlightNewPosts,this);this.addPosts=c(this.addPosts,this);this._bindNewPosts=c(this._bindNewPosts,this);this.getPost=c(this.getPost,this);this.$getPost=c(this.$getPost,this);this.$sel=this.$postContainer;null!=this.$topicContainer&&
(this.$sel=this.$sel.add(this.$topicContainer));this.posts=[];this.bind()}a.prototype.$getPost=function(b){return this.$sel.find(".post[data-id="+b+"]")};a.prototype.getPost=function(b){return _.findWhere(this.posts,{id:b})};a.prototype._bindNewPosts=function(){var b;b=this;return this.$sel.find(".post.post-new").each(function(){var d,a,f,e,c;f=$(this).removeClass("post-new");c=f.data("id");e=b.getPost(c);a=f.find("> .right > .header");d=f.find("> .right > .footer");a.find("a.user").click(function(){null!=
e&&e.userName&&mainBean.showUser(e.userName);return!1});d.find(".btn-edit").click(function(){e&&q(e);return!1});d.find(".btn-reply").click(function(){b.topicId&&c&&r(b.topicId,c);return!1});(null!=e&&e.likeCount||null!=e&&e.dislikeCount)&&d.find(".like-group").removeClass("fade-in");d.find(".btn.like").click(function(){var b,a,g,k;e&&USER_NAME&&USER_NAME!==e.userName&&(b=d.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),g=b.find(".value"),g.text(-1+Number(g.text()))),a=$(this),
a.parent(".like-group").removeClass("fade-in"),k=a.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:c,type:"like",value:k?0:1},success:function(b){return function(){a.toggleClass("selected");g=a.find(".value");return g.text((k?-1:1)+Number(g.text()))}}(this)}));return!1});return d.find(".btn.dislike").click(function(){var b,a,g,k;e&&USER_NAME&&USER_NAME!==e.userName&&(b=d.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),g=b.find(".value"),
g.text(-1+Number(g.text()))),a=$(this),a.parent(".like-group").removeClass("fade-in"),k=a.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:c,type:"like",value:k?0:-1},success:function(b){return function(){a.toggleClass("selected");g=a.find(".value");return g.text((k?-1:1)+Number(g.text()))}}(this)}));return!1})})};a.prototype.addPosts=function(b){var a,c,f,e,n,l;this.posts.push.apply(this.posts,b);(c=function(){var a,d,c;c=[];a=0;for(d=b.length;a<
d;a++)f=b[a],"post"===f.type&&c.push(h(f));return c}().join(""))&&this.$postContainer.append(c);null!=this.$topicContainer&&(c=function(){var a,d,c;c=[];a=0;for(d=b.length;a<d;a++)f=b[a],"topic"===f.type&&c.push(h(f));return c}().join(""))&&this.$topicContainer.append(c);e=function(){var a,d,c;c=[];a=0;for(d=b.length;a<d;a++)f=b[a],"reply"===f.type&&c.push(f);return c}();if(e.length)for(e=_.sortBy(e,function(b){return b.createTime}),n=0,l=e.length;n<l;n++)f=e[n],a=this.$getPost(f.replyId),a.length?
(c=h(f),a.children(".reply").append(c)):m("addPosts: error: post lost");return this._bindNewPosts()};a.prototype._highlightNewPosts=function(){return this.$sel.find(".post.post-new").effect("highlight",1500)};a.prototype.addPost=function(b){var a;this.posts.push(b);if("post"===b.type)return b=h(b),this.$postContainer.prepend(b),this._highlightNewPosts(),this._bindNewPosts();if("topic"===b.type){if(null!=this.$topicContainer)return b=h(b),this.$topicContainer.append(b),this._highlightNewPosts(),this._bindNewPosts()}else return"reply"===
b.type?(a=this.$getPost(b.replyId),a.length?(b=h(b),a.children(".reply").append(b),this._highlightNewPosts(),this._bindNewPosts()):m("addPost: error: post lost")):m("addPost: error: unknown post type")};a.prototype.updatePost=function(b){var a;if(a=this.getPost(b.id))if(util.fillObject(a,b),a=this.$getPost(b.id),a.length){b=$(h(b));b.children(".reply").replaceWith(a.children(".reply"));a.replaceWith(b);this._highlightNewPosts();this._bindNewPosts();return}return m("updatePost: error: post lost")};
a.prototype.bind=function(){var a;a=this;return this.$more.hide().click(function(){var c;c=$(this);c.data("locked")||(c.data("lock",!0),a.more(),c.data("lock",!1));return!1})};a.prototype.refresh=function(){var a;this.$topicContainer.empty();null!=(a=this.$postContainer)&&a.empty();return this.show()};a.prototype.show=function(){var a,c;c=this;spin(!0);a={topic:this.topicId,limit:10};_.extend(a,this.search);return rest.forum.list("post",{data:a,error:function(){spin(!1);return growl.warn(tr("Internet error"))},
success:function(a){spin(!1);if(a.length)return c.addPosts(a),c.$more.show()}})};a.prototype.more=function(){var a,c;c=this;spin(!0);a={topic:this.topicId,first:this.posts.length,limit:20};_.extend(a,this.search);return rest.forum.list("post",{data:a,error:function(){spin(!1);return growl.warn(tr("Internet error"))},success:function(a){spin(!1);return a.length?c.addPosts(a):growl(tr("No more"))}})};return a}()}}).call(this);
