(function(){var q,s,k,t,w,p,x,l,y,u,r,v,z,A,n,B,d;l=function(){return console.log.apply(console,arguments)};s=document.title;x=function(){return this.HAML_POST=Haml(('.post.post-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+'")\n  .right\n    .header\n      %a.user(href="javascript:" style="${userStyle}") @${userName}\n      .time.text-minor = createTime\n      .lang = lang\n      .time.text-success = updateTime\n    .content.bbcode = content\n    :if USER_NAME && USER_NAME != \'guest\'\n      .footer\n        .btn-group.like-group.fade-in\n          %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'")\n            %span.fa.fa-thumbs-up\n            %span.value = likeCount\n          %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'")\n            %span.fa.fa-thumbs-down\n            %span.value = dislikeCount\n        .btn-group.pull-right.fade-in\n          :if userName == USER_NAME\n            %a.btn.btn-link.btn-sm.btn-edit(role="button" title="'+tr("Edit")+'") '+tr("Edit")+'\n          %a.btn.btn-link.btn-sm.btn-reply(role="button" title="'+tr("Reply")+'") '+
tr("Reply")+'\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.title}")\n          %img(src="${image.url}" alt="${image.title}")\n  .reply').replace(/\$/g,"#"))};k=[];n=function(a){return HAML_POST({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>a.createTime?
util.formatDate(a.updateTime):"",image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0})};q=function(a){return $(".post[data-id="+a+"]")};u=function(a){return _.findWhere(k,{id:a})};y=function(a){return postEditBean.editPost(JSON.stringify(a))};B=function(a){return postInputBean.replyPost(a)};p=function(){return $(".post.post-new").each(function(){var a,b,h,c,g;h=$(this).removeClass("post-new");g=h.data("id");c=u(g);b=h.find("> .right > .header");
a=h.find("> .right > .footer");b.find("a.user").click(function(){null!=c&&c.userName&&mainBean.showUser(c.userName);return!1});a.find(".btn-edit").click(function(){c&&y(c);return!1});a.find(".btn-reply").click(function(){B(g);return!1});(null!=c&&c.likeCount||null!=c&&c.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var b,e,f,m;c&&USER_NAME&&USER_NAME!==c.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),f=b.find(".value"),
f.text(-1+Number(f.text()))),e=$(this),e.parent(".like-group").removeClass("fade-in"),m=e.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:g,type:"like",value:m?0:1},success:function(a){return function(){e.toggleClass("selected");f=e.find(".value");return f.text((m?-1:1)+Number(f.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,e,f,m;c&&USER_NAME&&USER_NAME!==c.userName&&(b=a.find(".btn.like.selected"),b.length&&
(b.removeClass("selected"),f=b.find(".value"),f.text(-1+Number(f.text()))),e=$(this),e.parent(".like-group").removeClass("fade-in"),m=e.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"post",targetId:g,type:"like",value:m?0:-1},success:function(a){return function(){e.toggleClass("selected");f=e.find(".value");return f.text((m?-1:1)+Number(f.text()))}}(this)}));return!1})})};t=function(a){var b,h,c,g,d,e;k.push.apply(k,a);document.title=""+s+" ("+k.length+
")";h=function(){var b,e,d;d=[];b=0;for(e=a.length;b<e;b++)c=a[b],"post"===c.type&&d.push(n(c));return d}().join("");$(".topic > .posts").append(h);g=function(){var b,e,d;d=[];b=0;for(e=a.length;b<e;b++)c=a[b],"reply"===c.type&&d.push(c);return d}();if(g.length)for(g=_.sortBy(g,function(a){return a.createTime}),d=0,e=g.length;d<e;d++)c=g[d],b=q(c.replyId),b.length?(h=n(c),b.children(".reply").append(h)):l("addPosts: error: post lost");return p()};r=function(){return $(".post.post-new").effect("highlight",
1500)};d=function(a){return $("#spin").spin(a?"large":!1)};A=function(){d(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",asc:!1,limit:20},error:function(){d(!1);return growl.warn(tr("Internet error"))},success:function(a){d(!1);return a.length?t(a):growl.warn(tr("Internet error"))}})};z=function(){d(!0);return rest.forum.list("post",{data:{topic:TOPIC_ID,sort:"updateTime",asc:!1,first:k.length,limit:20},error:function(){d(!1);return growl.warn(tr("Internet error"))},success:function(a){d(!1);
return a.length?t(a):growl(tr("No more"))}})};w=function(){return $(".topic > .footer > .btn-more").click(function(){var a;a=$(this);a.data("locked")||(a.data("lock",!0),z(),a.data("lock",!1));return!1})};this.READY=!1;this.addPost=function(a){var b;k.push(a);document.title=""+s+" ("+k.length+")";return"post"===a.type?(a=n(a),$(".topic > .posts").prepend(a),r(),p()):"reply"===a.type?(b=q(a.replyId),b.length?(a=n(a),b.children(".reply").append(a),r(),p()):l("addPost: error: post lost")):l("addPost: error: unknown post type")};
this.updatePost=function(a){var b;if(b=u(a.id))if(util.fillObject(b,a),b=q(a.id),b.length){a=$(n(a));a.children(".reply").replaceWith(b.children(".reply"));b.replaceWith(a);r();p();return}return l("updatePost: error: post lost")};v=function(){if(null==this.i18nBean)return l("init: wait"),setTimeout(v,100);l("init: enter");moment.locale("ja");x();w();A();this.READY=!0;return l("init: leave")};$(function(){return v()})}).call(this);
