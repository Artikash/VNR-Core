(function(){var x,n,b,h,p,q,y,m,z,k,A,r,s,t,B,C,l,u,v,w,D,c,E;k=function(){return console.log.apply(console,arguments)};n=document.title;z=function(){this.HTML_EMPTY="<div class='empty'>("+tr("Empty")+")</div>";this.HTML_NOMORE="<div class='empty'>("+tr("No more")+")</div>";return this.HAML_TOPIC=Haml(('.topic.topic-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+
"\")\n  .right\n    .header\n      %a.item.title(href='javascript:' title=\""+tr("Browse")+'") ${title}\n      %span.pull-right\n        %a.item.user(href="javascript:") @${userName}\n        .item.text-minor = lang\n        .item.text-minor = createTime\n        .item.text-success = updateTime\n    :if scores\n      .score\n        .pp-table.dock\n          :if scores.overall != undefined\n            .pp-row(data-type=\'overall\')\n              .pp-name '+tr("Score")+':\n              .pp-value ${scores.overall}/10\n          :if scores.ecchi != undefined\n            .pp-row(data-type=\'ecchi\')\n              .pp-name H:\n              .pp-value ${scores.ecchi}/10\n    .content.bbcode = content\n    .footer\n      .btn-group.like-group\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+
tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group\n        %a.btn-reply.btn.btn-link.btn-sm(role="button" title="'+tr("Reply")+'" title="'+tr("Browse")+'")\n          '+tr("Reply")+"\n          :if postCount\n            = ' (' + postCount + ')'\n      :if userName == USER_NAME\n        .btn-group.pull-right\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+
tr("Edit")+'") = tr(\'Edit\')\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.url}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,"#"))};b=[];h=null;l=function(a){return HAML_TOPIC({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),title:a.title,content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>
a.createTime?util.formatDate(a.updateTime):"",image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,postCount:a.postCount,scores:a.scores})};x=function(a){return $(".topic[data-id="+a+"]")};r=function(a){return _.findWhere(b,{id:a})};A=function(a){return topicEditBean.editTopic(JSON.stringify(a))};C=function(a){return topicInputBean.newTopic(a)};w=function(a){return topicInputBean.replyTopic(a)};m=function(){return $(".topic.topic-new").each(function(){var a,
d,b,e,c;b=$(this).removeClass("topic-new");c=b.data("id");e=r(c);d=b.find("> .right > .header");a=b.find("> .right > .footer");d.find("a.user").click(function(){null!=e&&e.userName&&mainBean.showUser(e.userName);return!1});a.find(".btn-edit").click(function(){e&&A(e);return!1});a.find(".btn-reply").click(function(){w(e);return!1});d.find(".title").click(function(){w(e);return!1});(null!=e&&e.likeCount||null!=e&&e.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var d,
b,f,g;e&&USER_NAME&&USER_NAME!==e.userName&&(d=a.find(".btn.dislike.selected"),d.length&&(d.removeClass("selected"),f=d.find(".value"),f.text(-1+Number(f.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),g=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:c,type:"like",value:g?0:1},success:function(a){return function(){b.toggleClass("selected");f=b.find(".value");return f.text((g?-1:1)+Number(f.text()))}}(this)}));return!1});
return a.find(".btn.dislike").click(function(){var d,b,f,g;e&&USER_NAME&&USER_NAME!==e.userName&&(d=a.find(".btn.like.selected"),d.length&&(d.removeClass("selected"),f=d.find(".value"),f.text(-1+Number(f.text()))),b=$(this),b.parent(".like-group").removeClass("fade-in"),g=b.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:c,type:"like",value:g?0:-1},success:function(a){return function(){b.toggleClass("selected");f=b.find(".value");return f.text((g?
-1:1)+Number(f.text()))}}(this)}));return!1})})};q=function(a){var d,g;a=_.filter(a,function(a){return"review"===a.type});if(a.length)return b.push.apply(b,a),document.title=""+n+" ("+b.length+")",USER_NAME&&(d=_.findWhere(a,{userName:USER_NAME}))&&(h=d,console.log("addTopics: found user topic"),a=_.without(a,d),v()),a.length&&(d=function(){var b,d,c;c=[];b=0;for(d=a.length;b<d;b++)g=a[b],"review"===g.type&&c.push(l(g));return c}().join(""),$(".topics").append(d)),m(),u()};s=function(){return $(".topic.topic-new").effect("highlight",
1500)};p=function(a){if("review"===a.type)return b.push(a),document.title=""+n+" ("+b.length+")",a.userName===USER_NAME?(h=a,v()):(a=l(a),$(".topics > .middle").after(a)),s(),m()};v=function(){var a;if(h)return a=l(h),$(a).addClass(".topic-user").replaceAll(".topic-user")};u=function(){var a;if(20>b.length||b.length%20>(h?1:0))return a=b.length?HTML_NOMORE:HTML_EMPTY,$(".sec-topic .btn-more").replaceWith(a)};c=function(a){return $("#spin").spin(a?"large":!1)};D=function(){c(!0);return rest.forum.list("topic",
{data:{subjectId:GAME_ID,subjectType:"game",type:"review",sort:"updateTime",asc:!1,limit:20,complete:!0},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);if(a.length){if(q(a),USER_NAME&&!h&&20===b.length)return E}else return u()}})};E=function(){c(!0);return rest.forum.list("topic",{data:{subjectId:GAME_ID,subjectType:"game",userName:USER_NAME,type:"review",limit:1,complete:!0},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);
if(1===a.length)return p(a[0])}})};B=function(){c(!0);return rest.forum.list("topic",{data:{subjectId:GAME_ID,subjectType:"game",sort:"updateTime",asc:!1,complete:!0,first:b.length-b.length%20,limit:20},error:function(){c(!1);return growl.warn(tr("Internet error"))},success:function(a){c(!1);return a.length?q(a):growl(tr("No more"))}})};y=function(){$(".sec-topic .btn-more").click(function(){var a;a=$(this);a.data("locked")||(a.data("lock",!0),B(),a.data("lock",!1));return!1});$(".sec-topic .btn-new").click(function(){C("review");
return!1});return $(".sec-btn").click(function(){var a,b,c;c=$(this);a=c.parent(".sec");a.length&&(b=a.find(".sec-content"),b.is(":empty")&&c.hasClass("checked")||(c.toggleClass("checked"),b.is(":empty")||(b.toggle("blind"),a.find(".sec-footer").toggle("blind"))));return!0})};this.READY=!1;this.addTopic=p;this.updateTopic=function(a){var b;if(b=r(a.id))if(util.fillObject(b,a),b=x(a.id),b.length){a=$(l(a));b.replaceWith(a);s();m();return}return k("updateTopic: error: topic lost")};t=function(){if(null==
this.i18nBean)return k("init: wait"),setTimeout(t,100);k("init: enter");moment.locale("ja");z();y();D();this.READY=!0;return k("init: leave")};$(function(){return t()})}).call(this);
