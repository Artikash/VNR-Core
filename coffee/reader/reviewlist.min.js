(function(){var u,n,f,p,v,m,w,h,x,q,r,s,y,z,A,k,t,e;h=function(){return console.log.apply(console,arguments)};n=document.title;w=function(){return this.HAML_TOPIC=Haml(('.topic.topic-new(data-id="${id}" data-type="${type}")\n  :if userAvatarUrl\n    %a(href="${userAvatarUrl}" title="'+tr("Avatar")+'")\n      %img.img-circle.avatar(src="${userAvatarUrl}" alt="'+tr("Avatar")+"\")\n  .right\n    .header\n      %a.item.title(href='javascript:' title=\""+tr("Browse")+'") ${title}\n      %span.pull-right\n        %a.item.user(href="javascript:") @${userName}\n        .item.text-minor = lang\n        .item.text-minor = createTime\n        .item.text-success = updateTime\n    :if scores\n      .score\n        .pp-table.dock\n          :if scores.overall != undefined\n            .pp-row(data-type=\'overall\')\n              .pp-name '+
tr("Score")+':\n              .pp-value ${scores.overall}/10\n          :if scores.ecchi != undefined\n            .pp-row(data-type=\'ecchi\')\n              .pp-name H:\n              .pp-value ${scores.ecchi}/10\n    .content.bbcode = content\n    .footer\n      .btn-group.like-group\n        %a.like.btn.btn-link.btn-sm(role="button" title="'+tr("Like")+'" data-value="${likeCount}")\n          %span.fa.fa-thumbs-up\n          %span.value = likeCount\n        %a.dislike.btn.btn-link.btn-sm(role="button" title="'+
tr("Dislike")+'" data-value="${dislikeCount}")\n          %span.fa.fa-thumbs-down\n          %span.value = dislikeCount\n      .btn-group\n        %a.btn-reply.btn.btn-link.btn-sm(role="button" title="'+tr("Reply")+'" title="'+tr("Browse")+'")\n          '+tr("Reply")+"\n          :if postCount\n            = ' (' + postCount + ')'\n      :if userName == USER_NAME\n        .btn-group.pull-right\n          %a.btn-edit.btn.btn-link.btn-sm(role=\"button\" title=\""+tr("Edit")+'") = tr(\'Edit\')\n    :if image\n      .image\n        %a(href="${image.url}" title="${image.url}")\n          %img(src="${image.url}" alt="${image.title}")').replace(/\$/g,
"#"))};f=[];k=function(a){return HAML_TOPIC({id:a.id,type:a.type,userName:a.userName,userStyle:a.userColor?"color:"+a.userColor:"",lang:util.getLangName(a.lang),userAvatarUrl:util.getAvatarUrl(a.userAvatar),title:a.title,content:util.renderContent(a.content),createTime:util.formatDate(a.createTime),updateTime:a.updateTime>a.createTime?util.formatDate(a.updateTime):"",image:a.image?{title:a.image.title,url:util.getImageUrl(a.image)}:null,likeCount:a.likeCount||0,dislikeCount:a.dislikeCount||0,postCount:a.postCount,
scores:a.scores})};u=function(a){return $(".topic[data-id="+a+"]")};q=function(a){return _.findWhere(f,{id:a})};x=function(a){return topicEditBean.editTopic(JSON.stringify(a))};t=function(a){return topicInputBean.replyTopic(a)};m=function(){return $(".topic.topic-new").each(function(){var a,b,c,d,f;c=$(this).removeClass("topic-new");f=c.data("id");d=q(f);b=c.find("> .right > .header");a=c.find("> .right > .footer");b.find("a.user").click(function(){null!=d&&d.userName&&mainBean.showUser(d.userName);
return!1});a.find(".btn-edit").click(function(){d&&x(d);return!1});a.find(".btn-reply").click(function(){t(d);return!1});b.find(".title").click(function(){t(d);return!1});(null!=d&&d.likeCount||null!=d&&d.dislikeCount)&&a.find(".like-group").removeClass("fade-in");a.find(".btn.like").click(function(){var b,l,g,c;d&&USER_NAME&&USER_NAME!==d.userName&&(b=a.find(".btn.dislike.selected"),b.length&&(b.removeClass("selected"),g=b.find(".value"),g.text(-1+Number(g.text()))),l=$(this),l.parent(".like-group").removeClass("fade-in"),
c=l.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:f,type:"like",value:c?0:1},success:function(a){return function(){l.toggleClass("selected");g=l.find(".value");return g.text((c?-1:1)+Number(g.text()))}}(this)}));return!1});return a.find(".btn.dislike").click(function(){var b,c,g,e;d&&USER_NAME&&USER_NAME!==d.userName&&(b=a.find(".btn.like.selected"),b.length&&(b.removeClass("selected"),g=b.find(".value"),g.text(-1+Number(g.text()))),c=
$(this),c.parent(".like-group").removeClass("fade-in"),e=c.hasClass("selected"),ticket.update({data:{login:USER_NAME,password:USER_PASSWORD,targetType:"topic",targetId:f,type:"like",value:e?0:-1},success:function(a){return function(){c.toggleClass("selected");g=c.find(".value");return g.text((e?-1:1)+Number(g.text()))}}(this)}));return!1})})};p=function(a){var b;f.push.apply(f,a);document.title=""+n+" ("+f.length+")";USER_NAME&&(b=_.findWhere(a,{userName:USER_NAME}))&&(console.log("addTopics: found user topic"),
a=_.without(a,b),A(b));if(a.length){var c,d,e;e=[];c=0;for(d=a.length;c<d;c++)b=a[c],"review"===b.type&&e.push(k(b));a=e.join("");$(".topics").append(a)}return m()};r=function(){return $(".topic.topic-new").effect("highlight",1500)};A=function(a){var b;a=k(a);b=$(a).addClass(".topic-user");a=$(".topic.topic-user");return a.length?a.html(b):$(".topics").prepend(b)};e=function(a){return $("#spin").spin(a?"large":!1)};z=function(){e(!0);return rest.forum.list("topic",{data:{subjectId:GAME_ID,subjectType:"game",
type:"review",sort:"updateTime",asc:!1,limit:20,complete:!0},error:function(){e(!1);return growl.warn(tr("Internet error"))},success:function(a){e(!1);return a.length?p(a):growl(tr("Empty")+" > <")}})};y=function(){e(!0);return rest.forum.list("topic",{data:{subjectId:GAME_ID,subjectType:"game",sort:"updateTime",asc:!1,complete:!0,first:f.length,limit:20},error:function(){e(!1);return growl.warn(tr("Internet error"))},success:function(a){e(!1);return a.length?p(a):growl(tr("No more"))}})};v=function(){return $(".game > .footer > .btn-more").click(function(){var a;
a=$(this);a.data("locked")||(a.data("lock",!0),y(),a.data("lock",!1));return!1})};this.READY=!1;this.addTopic=function(a){f.push(a);document.title=""+n+" ("+f.length+")";return"review"===a.type?(a=k(a),$(a).prependTo(".topics"),r(),m()):h("addTopic: error: unknown topic type")};this.updateTopic=function(a){var b;if(b=q(a.id))if(util.fillObject(b,a),b=u(a.id),b.length){a=$(k(a));b.replaceWith(a);r();m();return}return h("updateTopic: error: topic lost")};s=function(){if(null==this.i18nBean)return h("init: wait"),
setTimeout(s,100);h("init: enter");moment.locale("ja");w();v();z();this.READY=!0;return h("init: leave")};$(function(){return s()})}).call(this);
